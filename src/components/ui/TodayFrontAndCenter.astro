<section class="mx-auto max-w-6xl px-3 pt-6 min-[375px]:px-4 min-[430px]:pt-8">
  <div class="rounded-xl border-2 border-gold-300 bg-cream-100/90 p-4 shadow-sm min-[430px]:p-6">
    <div
      class="flex flex-col gap-3 min-[520px]:flex-row min-[520px]:items-end min-[520px]:justify-between"
    >
      <div>
        <p
          class="font-mono text-[11px] uppercase tracking-[0.2em] text-gold-600 min-[375px]:text-xs"
        >
          Live Public Sources
        </p>
        <h2 class="font-serif text-2xl font-bold text-navy-900 min-[375px]:text-3xl">
          Today in Congress
        </h2>
        <p id="today-front-date" class="mt-1 font-sans text-sm text-navy-600">
          Loading current-day chamber activity...
        </p>
      </div>
      <a
        href="/today"
        class="inline-flex items-center justify-center rounded border border-navy-700 bg-navy-800 px-4 py-2 font-sans text-sm font-semibold text-white transition-colors hover:bg-navy-700"
      >
        Full Daily Dispatch
      </a>
    </div>

    <div
      id="today-front-loading"
      class="mt-4 rounded-lg bg-cream-200 p-3 font-sans text-sm text-navy-700"
    >
      Fetching House floor, Senate floor, and committee schedules.
    </div>

    <div
      id="today-front-error"
      class="mt-4 hidden rounded-lg border border-red-600/40 bg-red-600/10 p-3 font-sans text-sm text-red-700"
    >
      Unable to load live congressional data right now.
      <a href="/today" class="underline text-red-700 hover:text-red-600">Open the Today page</a> for retry
      and source links.
    </div>

    <div id="today-front-content" class="mt-5 hidden space-y-5">
      <p
        id="today-front-deck"
        class="rounded-lg border border-gold-200 bg-cream-100 px-3 py-2 font-serif text-base italic text-navy-800"
      >
        -
      </p>

      <div class="grid grid-cols-1 gap-3 min-[520px]:grid-cols-2">
        <article class="rounded-lg border border-gold-200 bg-cream-100 p-3">
          <p class="font-mono text-[11px] uppercase tracking-[0.18em] text-gold-700">House</p>
          <p id="today-front-house-status" class="mt-1 font-serif text-xl font-bold text-navy-900">
            -
          </p>
          <p id="today-front-house-line" class="mt-1 font-sans text-sm text-navy-700">-</p>
        </article>
        <article class="rounded-lg border border-gold-200 bg-cream-100 p-3">
          <p class="font-mono text-[11px] uppercase tracking-[0.18em] text-gold-700">Senate</p>
          <p id="today-front-senate-status" class="mt-1 font-serif text-xl font-bold text-navy-900">
            -
          </p>
          <p id="today-front-senate-line" class="mt-1 font-sans text-sm text-navy-700">-</p>
        </article>
      </div>

      <div>
        <h3 class="font-serif text-lg font-bold text-navy-900">At a Glance</h3>
        <div id="today-front-bullets" class="mt-3 grid grid-cols-1 gap-3 min-[520px]:grid-cols-2"></div>
      </div>

      <div>
        <h3 class="font-serif text-lg font-bold text-navy-900">Today&apos;s Meetings</h3>
        <div id="today-front-meetings" class="mt-3 grid grid-cols-1 gap-2 min-[520px]:grid-cols-2"></div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    type TodayMeeting = {
      chamber?: string;
      time?: string;
      committee?: string;
      title?: string;
      focus?: string;
      relatedBillCount?: number;
      relatedNominationCount?: number;
      isClosed?: boolean;
    };

    const dateEl = document.getElementById('today-front-date');
    const loadingEl = document.getElementById('today-front-loading');
    const errorEl = document.getElementById('today-front-error');
    const contentEl = document.getElementById('today-front-content');
    const deckEl = document.getElementById('today-front-deck');
    const houseStatusEl = document.getElementById('today-front-house-status');
    const houseLineEl = document.getElementById('today-front-house-line');
    const senateStatusEl = document.getElementById('today-front-senate-status');
    const senateLineEl = document.getElementById('today-front-senate-line');
    const bulletsEl = document.getElementById('today-front-bullets');
    const meetingsEl = document.getElementById('today-front-meetings');

    if (
      !(dateEl instanceof HTMLElement) ||
      !(loadingEl instanceof HTMLElement) ||
      !(errorEl instanceof HTMLElement) ||
      !(contentEl instanceof HTMLElement) ||
      !(deckEl instanceof HTMLElement) ||
      !(houseStatusEl instanceof HTMLElement) ||
      !(houseLineEl instanceof HTMLElement) ||
      !(senateStatusEl instanceof HTMLElement) ||
      !(senateLineEl instanceof HTMLElement) ||
      !(bulletsEl instanceof HTMLElement) ||
      !(meetingsEl instanceof HTMLElement)
    ) {
      // Markup changed or script is running in a non-DOM context.
      // Fail closed: keep the page static and avoid noisy errors.
      return;
    }

    const safeDateEl: HTMLElement = dateEl;
    const safeLoadingEl: HTMLElement = loadingEl;
    const safeErrorEl: HTMLElement = errorEl;
    const safeContentEl: HTMLElement = contentEl;
    const safeDeckEl: HTMLElement = deckEl;
    const safeHouseStatusEl: HTMLElement = houseStatusEl;
    const safeHouseLineEl: HTMLElement = houseLineEl;
    const safeSenateStatusEl: HTMLElement = senateStatusEl;
    const safeSenateLineEl: HTMLElement = senateLineEl;
    const safeBulletsEl: HTMLElement = bulletsEl;
    const safeMeetingsEl: HTMLElement = meetingsEl;

    function truncate(text: string, max = 170): string {
      if (!text || text.length <= max) return text || '';
      return `${text.slice(0, max - 1).trim()}...`;
    }

    function statusColor(status: string): string {
      if (/adjourned/i.test(status || '')) return 'text-red-700';
      if (/session/i.test(status || '')) return 'text-green-700';
      return 'text-navy-900';
    }

    function renderBulletCards(values: string[]) {
      safeBulletsEl.replaceChildren();

      const categories: [RegExp, string][] = [
        [/^Power center/i, 'Activity'],
        [/^Top agenda/i, 'Agenda'],
        [/^Policy load/i, 'Policy Load'],
        [/^Transparency/i, 'Transparency'],
        [/^Paper trail/i, 'Records'],
      ];

      values.forEach((value) => {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-gold-200 bg-cream-50 p-3';

        let label = 'Update';
        let body = value;

        for (const [pattern, catLabel] of categories) {
          if (pattern.test(value)) {
            label = catLabel;
            const colonIdx = value.indexOf(':');
            if (colonIdx > 0) body = value.slice(colonIdx + 1).trim();
            break;
          }
        }

        const labelEl = document.createElement('p');
        labelEl.className = 'font-mono text-[10px] uppercase tracking-[0.16em] text-gold-600';
        labelEl.textContent = label;

        const textEl = document.createElement('p');
        textEl.className = 'mt-1 font-sans text-sm leading-relaxed text-navy-700';
        textEl.textContent = body;

        card.appendChild(labelEl);
        card.appendChild(textEl);
        safeBulletsEl.appendChild(card);
      });
    }

    function renderMeetingCards(meetings: TodayMeeting[]) {
      safeMeetingsEl.replaceChildren();

      if (meetings.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'col-span-full font-sans text-sm text-navy-600';
        empty.textContent = 'No House or Senate committee meetings listed today.';
        safeMeetingsEl.appendChild(empty);
        return;
      }

      meetings.forEach((meeting) => {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-gold-200 bg-cream-50 p-3';

        const topRow = document.createElement('div');
        topRow.className = 'flex flex-wrap items-center gap-2';

        const chamberBadge = document.createElement('span');
        const isHouse = (meeting.chamber || '').toLowerCase() === 'house';
        chamberBadge.className = isHouse
          ? 'rounded-full bg-navy-800 px-2 py-0.5 font-mono text-[10px] uppercase tracking-wider text-cream-100'
          : 'rounded-full bg-gold-700 px-2 py-0.5 font-mono text-[10px] uppercase tracking-wider text-cream-100';
        chamberBadge.textContent = meeting.chamber || 'Committee';
        topRow.appendChild(chamberBadge);

        if (meeting.time) {
          const timeEl = document.createElement('span');
          timeEl.className = 'font-mono text-xs text-navy-500';
          timeEl.textContent = meeting.time;
          topRow.appendChild(timeEl);
        }

        if (meeting.isClosed) {
          const closedBadge = document.createElement('span');
          closedBadge.className =
            'rounded bg-red-100 px-1.5 py-0.5 font-mono text-[10px] uppercase text-red-700';
          closedBadge.textContent = 'Closed';
          topRow.appendChild(closedBadge);
        }

        const title = document.createElement('p');
        title.className = 'mt-1.5 font-serif text-sm font-bold text-navy-900';
        title.textContent = truncate(meeting.committee || meeting.title || 'Committee meeting', 80);

        const focusText = meeting.focus || '';

        card.appendChild(topRow);
        card.appendChild(title);

        if (focusText) {
          const focusEl = document.createElement('p');
          focusEl.className = 'mt-0.5 font-sans text-xs text-navy-500';
          focusEl.textContent = focusText;
          card.appendChild(focusEl);
        }

        const meta: string[] = [];
        const billCount = typeof meeting.relatedBillCount === 'number' ? meeting.relatedBillCount : 0;
        const nomCount = typeof meeting.relatedNominationCount === 'number' ? meeting.relatedNominationCount : 0;
        if (billCount > 0) meta.push(`${billCount} bill${billCount === 1 ? '' : 's'}`);
        if (nomCount > 0) meta.push(`${nomCount} nomination${nomCount === 1 ? '' : 's'}`);

        if (meta.length > 0) {
          const metaEl = document.createElement('p');
          metaEl.className = 'mt-1 font-sans text-[11px] text-navy-400';
          metaEl.textContent = meta.join(' \u00b7 ');
          card.appendChild(metaEl);
        }

        safeMeetingsEl.appendChild(card);
      });
    }

    async function requestTodayData() {
      const endpoints = ['/api/today.json', '/api/today-fallback.json'];
      let lastError: unknown;

      for (const endpoint of endpoints) {
        try {
          const response = await fetch(endpoint, {
            headers: { Accept: 'application/json' },
          });
          if (!response.ok) {
            lastError = new Error(`${endpoint} returned HTTP ${response.status}`);
            continue;
          }
          const data = await response.json();
          return data;
        } catch (error: unknown) {
          lastError = error;
        }
      }

      throw lastError instanceof Error
        ? lastError
        : new Error('Unable to load today data from available endpoints.');
    }

    async function loadTodayFront() {
      try {
        const data = await requestTodayData();
        safeDateEl.textContent = data?.today?.label || 'Today';

        const house = data?.chambers?.house || {};
        safeHouseStatusEl.textContent = house.status || 'No update';
        safeHouseStatusEl.className = `mt-1 font-serif text-xl font-bold ${statusColor(house.status)}`;

        const houseLine = house.latestAction?.text
          ? `${house.latestAction.time ? `${house.latestAction.time}: ` : ''}${house.latestAction.text}`
          : house.nextConvene
            ? `Next House meeting: ${house.nextConvene}`
            : 'No House floor action posted yet.';
        safeHouseLineEl.textContent = truncate(houseLine);

        const senate = data?.chambers?.senate || {};
        safeSenateStatusEl.textContent = senate.status || 'No update';
        safeSenateStatusEl.className = `mt-1 font-serif text-xl font-bold ${statusColor(senate.status)}`;

        const senateLine =
          senate.previousSummary ||
          (senate.nextConvene
            ? `Next Senate meeting: ${senate.nextConvene}`
            : 'No Senate floor summary posted yet.');
        safeSenateLineEl.textContent = truncate(senateLine);

        safeDeckEl.textContent =
          data?.summary?.deck ||
          'Satire desk is still warming up the teleprompter for this legislative day.';

        const bullets = Array.isArray(data?.summary?.bullets)
          ? data.summary.bullets.slice(0, 4).map(String)
          : ['No summary available yet.'];
        renderBulletCards(bullets);

        const meetings: TodayMeeting[] = Array.isArray(data?.committees?.meetings)
          ? data.committees.meetings.slice(0, 4)
          : [];
        renderMeetingCards(meetings);

        safeLoadingEl.classList.add('hidden');
        safeErrorEl.classList.add('hidden');
        safeContentEl.classList.remove('hidden');
      } catch (_error) {
        safeLoadingEl.classList.add('hidden');
        safeContentEl.classList.add('hidden');
        safeErrorEl.classList.remove('hidden');
      }
    }

    loadTodayFront();
  })();
</script>
