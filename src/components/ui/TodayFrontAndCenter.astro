<section class="mx-auto max-w-6xl px-3 pt-6 min-[375px]:px-4 min-[430px]:pt-8">
  <div class="rounded-xl border-2 border-gold-300 bg-cream-100/90 p-4 shadow-sm min-[430px]:p-6">
    <div
      class="flex flex-col gap-3 min-[520px]:flex-row min-[520px]:items-end min-[520px]:justify-between"
    >
      <div>
        <p
          class="font-mono text-[11px] uppercase tracking-[0.2em] text-gold-600 min-[375px]:text-xs"
        >
          Live Public Sources
        </p>
        <h2 class="font-serif text-2xl font-bold text-navy-900 min-[375px]:text-3xl">
          Today in Congress
        </h2>
        <p id="today-front-date" class="mt-1 font-sans text-sm text-navy-600">
          Loading current-day chamber activity...
        </p>
      </div>
      <a
        href="/today"
        class="inline-flex items-center justify-center rounded border border-navy-700 bg-navy-800 px-4 py-2 font-sans text-sm font-semibold text-white transition-colors hover:bg-navy-700"
      >
        Full Daily Dispatch
      </a>
    </div>

    <div
      id="today-front-loading"
      class="mt-4 rounded-lg bg-cream-200 p-3 font-sans text-sm text-navy-700"
    >
      Fetching House floor, Senate floor, and committee schedules.
    </div>

    <div
      id="today-front-error"
      class="mt-4 hidden rounded-lg border border-red-600/40 bg-red-600/10 p-3 font-sans text-sm text-red-700"
    >
      Unable to load live congressional data right now.
      <a href="/today" class="underline text-red-700 hover:text-red-600">Open the Today page</a> for retry
      and source links.
    </div>

    <div id="today-front-content" class="mt-5 hidden space-y-5">
      <p
        id="today-front-deck"
        class="rounded-lg border border-gold-200 bg-cream-100 px-3 py-2 font-serif text-base italic text-navy-800"
      >
        -
      </p>

      <div class="grid grid-cols-1 gap-3 min-[520px]:grid-cols-2">
        <article class="rounded-lg border border-gold-200 bg-cream-100 p-3">
          <p class="font-mono text-[11px] uppercase tracking-[0.18em] text-gold-700">House</p>
          <p id="today-front-house-status" class="mt-1 font-serif text-xl font-bold text-navy-900">
            -
          </p>
          <p id="today-front-house-line" class="mt-1 font-sans text-sm text-navy-700">-</p>
        </article>
        <article class="rounded-lg border border-gold-200 bg-cream-100 p-3">
          <p class="font-mono text-[11px] uppercase tracking-[0.18em] text-gold-700">Senate</p>
          <p id="today-front-senate-status" class="mt-1 font-serif text-xl font-bold text-navy-900">
            -
          </p>
          <p id="today-front-senate-line" class="mt-1 font-sans text-sm text-navy-700">-</p>
        </article>
      </div>

      <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
        <div>
          <h3 class="font-serif text-lg font-bold text-navy-900">At a Glance</h3>
          <ul id="today-front-bullets" class="mt-2 space-y-1 font-sans text-sm text-navy-700"></ul>
        </div>
        <div>
          <h3 class="font-serif text-lg font-bold text-navy-900">Today&apos;s Meetings</h3>
          <ul id="today-front-meetings" class="mt-2 space-y-1 font-sans text-sm text-navy-700"></ul>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (() => {
    type TodayMeeting = {
      chamber?: string;
      time?: string;
      committee?: string;
      title?: string;
      focus?: string;
      relatedBillCount?: number;
      relatedNominationCount?: number;
      isClosed?: boolean;
    };

    const dateEl = document.getElementById('today-front-date');
    const loadingEl = document.getElementById('today-front-loading');
    const errorEl = document.getElementById('today-front-error');
    const contentEl = document.getElementById('today-front-content');
    const deckEl = document.getElementById('today-front-deck');
    const houseStatusEl = document.getElementById('today-front-house-status');
    const houseLineEl = document.getElementById('today-front-house-line');
    const senateStatusEl = document.getElementById('today-front-senate-status');
    const senateLineEl = document.getElementById('today-front-senate-line');
    const bulletsEl = document.getElementById('today-front-bullets');
    const meetingsEl = document.getElementById('today-front-meetings');

    if (
      !(dateEl instanceof HTMLElement) ||
      !(loadingEl instanceof HTMLElement) ||
      !(errorEl instanceof HTMLElement) ||
      !(contentEl instanceof HTMLElement) ||
      !(deckEl instanceof HTMLElement) ||
      !(houseStatusEl instanceof HTMLElement) ||
      !(houseLineEl instanceof HTMLElement) ||
      !(senateStatusEl instanceof HTMLElement) ||
      !(senateLineEl instanceof HTMLElement) ||
      !(bulletsEl instanceof HTMLUListElement) ||
      !(meetingsEl instanceof HTMLUListElement)
    ) {
      // Markup changed or script is running in a non-DOM context.
      // Fail closed: keep the page static and avoid noisy errors.
      return;
    }

    const safeDateEl: HTMLElement = dateEl;
    const safeLoadingEl: HTMLElement = loadingEl;
    const safeErrorEl: HTMLElement = errorEl;
    const safeContentEl: HTMLElement = contentEl;
    const safeDeckEl: HTMLElement = deckEl;
    const safeHouseStatusEl: HTMLElement = houseStatusEl;
    const safeHouseLineEl: HTMLElement = houseLineEl;
    const safeSenateStatusEl: HTMLElement = senateStatusEl;
    const safeSenateLineEl: HTMLElement = senateLineEl;
    const safeBulletsEl: HTMLUListElement = bulletsEl;
    const safeMeetingsEl: HTMLUListElement = meetingsEl;

    function truncate(text: string, max = 170): string {
      if (!text || text.length <= max) return text || '';
      return `${text.slice(0, max - 1).trim()}...`;
    }

    function statusColor(status: string): string {
      if (/adjourned/i.test(status || '')) return 'text-red-700';
      if (/session/i.test(status || '')) return 'text-green-700';
      return 'text-navy-900';
    }

    function appendListItems(target: HTMLUListElement, items: string[]) {
      target.replaceChildren();
      items.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        target.appendChild(li);
      });
    }

    async function requestTodayData() {
      const endpoints = ['/api/today.json', '/api/today-fallback.json'];
      let lastError: unknown;

      for (const endpoint of endpoints) {
        try {
          const response = await fetch(endpoint, {
            headers: { Accept: 'application/json' },
          });
          if (!response.ok) {
            lastError = new Error(`${endpoint} returned HTTP ${response.status}`);
            continue;
          }
          const data = await response.json();
          return data;
        } catch (error: unknown) {
          lastError = error;
        }
      }

      throw lastError instanceof Error
        ? lastError
        : new Error('Unable to load today data from available endpoints.');
    }

    async function loadTodayFront() {
      try {
        const data = await requestTodayData();
        safeDateEl.textContent = data?.today?.label || 'Today';

        const house = data?.chambers?.house || {};
        safeHouseStatusEl.textContent = house.status || 'No update';
        safeHouseStatusEl.className = `mt-1 font-serif text-xl font-bold ${statusColor(house.status)}`;

        const houseLine = house.latestAction?.text
          ? `${house.latestAction.time ? `${house.latestAction.time}: ` : ''}${house.latestAction.text}`
          : house.nextConvene
            ? `Next House meeting: ${house.nextConvene}`
            : 'No House floor action posted yet.';
        safeHouseLineEl.textContent = truncate(houseLine);

        const senate = data?.chambers?.senate || {};
        safeSenateStatusEl.textContent = senate.status || 'No update';
        safeSenateStatusEl.className = `mt-1 font-serif text-xl font-bold ${statusColor(senate.status)}`;

        const senateLine =
          senate.previousSummary ||
          (senate.nextConvene
            ? `Next Senate meeting: ${senate.nextConvene}`
            : 'No Senate floor summary posted yet.');
        safeSenateLineEl.textContent = truncate(senateLine);

        safeDeckEl.textContent =
          data?.summary?.deck ||
          'Satire desk is still warming up the teleprompter for this legislative day.';

        const bullets = Array.isArray(data?.summary?.bullets)
          ? data.summary.bullets.slice(0, 4).map(String)
          : ['No summary available yet.'];
        appendListItems(safeBulletsEl, bullets);

        const meetings = Array.isArray(data?.committees?.meetings)
          ? data.committees.meetings.slice(0, 4)
          : [];
        if (meetings.length === 0) {
          appendListItems(safeMeetingsEl, ['No House or Senate committee meetings listed today.']);
        } else {
          appendListItems(
            safeMeetingsEl,
            meetings.map((meeting: TodayMeeting) => {
              const chamber = meeting.chamber || 'Committee';
              const time = meeting.time ? `${meeting.time} - ` : '';
              const title = meeting.committee || meeting.title || 'Committee meeting';
              const focus = meeting.focus ? ` (${meeting.focus})` : '';
              const extras = [];
              const relatedBillCount =
                typeof meeting.relatedBillCount === 'number' ? meeting.relatedBillCount : null;
              if (
                typeof relatedBillCount === 'number' &&
                Number.isFinite(relatedBillCount) &&
                relatedBillCount > 0
              ) {
                extras.push(`${relatedBillCount} bill${relatedBillCount === 1 ? '' : 's'}`);
              }
              const relatedNominationCount =
                typeof meeting.relatedNominationCount === 'number'
                  ? meeting.relatedNominationCount
                  : null;
              if (
                typeof relatedNominationCount === 'number' &&
                Number.isFinite(relatedNominationCount) &&
                relatedNominationCount > 0
              ) {
                extras.push(
                  `${relatedNominationCount} nomination${relatedNominationCount === 1 ? '' : 's'}`,
                );
              }
              if (meeting.isClosed) {
                extras.push('closed');
              }
              const extraText = extras.length > 0 ? ` [${extras.join(', ')}]` : '';
              return `${time}${chamber}: ${truncate(`${title}${focus}${extraText}`, 120)}`;
            }),
          );
        }

        safeLoadingEl.classList.add('hidden');
        safeErrorEl.classList.add('hidden');
        safeContentEl.classList.remove('hidden');
      } catch (_error) {
        safeLoadingEl.classList.add('hidden');
        safeContentEl.classList.add('hidden');
        safeErrorEl.classList.remove('hidden');
      }
    }

    loadTodayFront();
  })();
</script>
