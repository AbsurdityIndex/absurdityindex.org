---
interface Division {
  title: string;
  shortTitle?: string;
  spending: number;
  description?: string;
}

interface Props {
  divisions: Division[];
  totalSpending: number;
}

const { divisions, totalSpending } = Astro.props;

// Color palette for divisions (government-appropriate colors)
const colors = [
  { bg: 'bg-navy-700', text: 'text-cream-100', hex: '#1A2D4D' },
  { bg: 'bg-gold-500', text: 'text-navy-900', hex: '#C5A572' },
  { bg: 'bg-red-700', text: 'text-cream-100', hex: '#8B1A1A' },
  { bg: 'bg-green-700', text: 'text-cream-100', hex: '#1A6B3A' },
  { bg: 'bg-navy-500', text: 'text-cream-100', hex: '#3A6FA0' },
  { bg: 'bg-gold-600', text: 'text-navy-900', hex: '#A88B4A' },
  { bg: 'bg-navy-800', text: 'text-cream-100', hex: '#121F36' },
  { bg: 'bg-gold-400', text: 'text-navy-900', hex: '#D4BB8A' },
  { bg: 'bg-red-600', text: 'text-cream-100', hex: '#A52020' },
  { bg: 'bg-green-600', text: 'text-cream-100', hex: '#228B4A' },
  { bg: 'bg-navy-600', text: 'text-cream-100', hex: '#2D5986' },
  { bg: 'bg-gold-300', text: 'text-navy-900', hex: '#E8D5B0' },
];

// Sort divisions by spending (largest first)
const sortedDivisions = [...divisions].sort((a, b) => b.spending - a.spending);

// Calculate percentages
const divisionsWithPercent = sortedDivisions.map((div, i) => ({
  ...div,
  percent: (div.spending / totalSpending) * 100,
  color: colors[i % colors.length],
}));
---

<div class="bg-cream-100 border border-gold-300 rounded-lg p-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="font-serif text-xl font-bold text-navy-900">Spending Breakdown</h3>
    <div class="text-right">
      <span class="font-mono text-2xl font-bold text-navy-900">${totalSpending.toFixed(1)}B</span>
      <span class="block text-xs text-navy-500">Total Spending</span>
    </div>
  </div>

  <!-- Stacked Bar Chart -->
  <div class="mb-6">
    <div class="h-12 rounded-lg overflow-hidden flex shadow-inner border border-gold-400">
      {divisionsWithPercent.map((div) => (
        <div
          class={`${div.color.bg} relative group cursor-pointer transition-all hover:brightness-110`}
          style={`width: ${Math.max(div.percent, 0.5)}%`}
          title={`${div.shortTitle || div.title}: $${div.spending}B (${div.percent.toFixed(1)}%)`}
        >
          {div.percent > 8 && (
            <span class={`absolute inset-0 flex items-center justify-center text-xs font-bold ${div.color.text} truncate px-1`}>
              {div.percent.toFixed(0)}%
            </span>
          )}
        </div>
      ))}
    </div>
  </div>

  <!-- Legend -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    {divisionsWithPercent.map((div) => (
      <div class="flex items-start gap-3 group" data-division={div.shortTitle || div.title}>
        <div class={`w-4 h-4 rounded ${div.color.bg} mt-0.5 shrink-0 shadow-sm`}></div>
        <div class="min-w-0">
          <div class="flex items-baseline gap-2">
            <span class="font-serif text-sm font-semibold text-navy-900 truncate">
              {div.shortTitle || div.title}
            </span>
            <span class="font-mono text-xs text-navy-600 shrink-0">
              ${div.spending}B
            </span>
          </div>
          {div.description && (
            <p class="text-xs text-navy-500 mt-0.5 line-clamp-2">{div.description}</p>
          )}
        </div>
      </div>
    ))}
  </div>

  <!-- Fun Comparison -->
  <div class="mt-6 pt-4 border-t border-gold-300">
    <p class="text-xs text-navy-600 italic text-center">
      <span class="font-semibold">{totalSpending.toFixed(1)} billion dollars</span> is roughly
      <span class="font-mono">{(totalSpending * 1000000000 / 330000000).toFixed(0)}</span> per American,
      or <span class="font-mono">{((totalSpending * 1000000000) / (365 * 24 * 3600)).toFixed(1)}</span> per second for a year.
    </p>
  </div>
</div>
