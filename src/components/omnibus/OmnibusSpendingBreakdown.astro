---
/**
 * OmnibusSpendingBreakdown - Interactive horizontal bar chart
 *
 * Replaces both the old OmnibusTableOfContents and OmnibusSpendingChart.
 * Bars sorted by spending, clickable to jump to divisions, highlighted
 * by scroll-spy in the page script.
 */
import Icon from '../ui/Icon.astro';

interface Division {
  title: string;
  shortTitle?: string;
  spending: number;
  description?: string;
}

interface Props {
  divisions: Division[];
  totalSpending: number;
}

const { divisions, totalSpending } = Astro.props;

// Sort by spending descending for display
const sorted = divisions
  .map((div, i) => ({ ...div, index: i }))
  .sort((a, b) => b.spending - a.spending);

const maxSpending = sorted[0]?.spending ?? 1;

// Color palette for bars
const barColors = [
  'bg-navy-800',
  'bg-gold-600',
  'bg-red-700',
  'bg-green-700',
  'bg-navy-600',
  'bg-gold-500',
  'bg-red-600',
  'bg-green-600',
  'bg-navy-500',
  'bg-gold-700',
  'bg-red-500',
  'bg-green-500',
];
---

<section
  class="bg-cream-100 border border-gold-300 rounded-lg overflow-hidden"
  data-section="spending"
>
  <div class="px-5 py-4 border-b border-gold-200 flex items-center justify-between">
    <h2 class="font-serif text-lg font-bold text-navy-900 flex items-center gap-2">
      <Icon name="bar-chart" size={18} class="text-gold-600" />
      Spending Breakdown
    </h2>
    <span class="text-xs font-mono text-navy-500">{divisions.length} divisions</span>
  </div>

  <div class="p-5 space-y-2.5">
    {
      sorted.map((div) => {
        const pct = totalSpending > 0 ? (div.spending / totalSpending) * 100 : 0;
        const barWidth = maxSpending > 0 ? (div.spending / maxSpending) * 100 : 0;
        const divLetter = String.fromCharCode(65 + div.index);
        const color = barColors[div.index % barColors.length];

        return (
          <button
            type="button"
            class="spending-bar w-full text-left group cursor-pointer hover:bg-cream-200 rounded-lg p-2 -mx-2 transition-colors"
            data-division-target={div.index + 1}
            title={`${div.title}: $${div.spending}B (${pct.toFixed(1)}%)`}
          >
            <div class="flex items-baseline justify-between mb-1">
              <span class="text-sm font-sans text-navy-800 group-hover:text-navy-900 truncate pr-2">
                <span class="font-mono text-xs text-gold-600 mr-1">{divLetter}.</span>
                {div.shortTitle || div.title}
              </span>
              <span class="text-xs font-mono text-navy-600 shrink-0">
                ${div.spending}B<span class="text-navy-400 ml-1">({pct.toFixed(1)}%)</span>
              </span>
            </div>
            <div class="h-3 bg-cream-300 rounded-full overflow-hidden">
              <div
                class:list={['h-full rounded-full transition-all duration-300', color]}
                style={`width: ${barWidth}%`}
              />
            </div>
          </button>
        );
      })
    }
  </div>

  <div class="px-5 py-3 bg-cream-200 border-t border-gold-200 text-center">
    <p class="text-xs text-navy-500">
      <Icon name="link" size={12} class="inline -mt-0.5 mr-1" />
      Click any bar to jump to that division
    </p>
  </div>
</section>

<style>
  /* Scroll-spy active state â€” set by page JS */
  .spending-bar[data-active='true'] {
    background-color: var(--color-gold-100);
    box-shadow: inset 3px 0 0 var(--color-gold-500);
  }
</style>
