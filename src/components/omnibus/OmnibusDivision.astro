---
/**
 * OmnibusDivision â€” Expandable division using native <details>/<summary>
 *
 * Matches the CollapsibleSection pattern for progressive disclosure.
 * Includes scroll-spy data attributes and a percentage bar in the header.
 */
import Icon from '../ui/Icon.astro';

interface Props {
  number: number;
  title: string;
  shortTitle?: string;
  spending: number;
  totalSpending: number;
  description?: string;
  content?: string;
  isExpanded?: boolean;
}

const {
  number,
  title,
  shortTitle,
  spending,
  totalSpending,
  description,
  content,
  isExpanded = false,
} = Astro.props;

const divisionLetter = String.fromCharCode(64 + number);
const slug = `division-${number}`;
const percent = totalSpending > 0 ? (spending / totalSpending) * 100 : 0;
---

<details
  id={slug}
  class="omnibus-division group bg-parchment border border-gold-300 rounded-lg overflow-hidden scroll-mt-24"
  data-section={slug}
  data-division={number}
  open={isExpanded}
>
  <summary
    class="flex items-center justify-between px-4 py-3 md:px-5 md:py-4 cursor-pointer select-none hover:bg-cream-200 transition-colors"
  >
    <div class="flex items-center gap-3 min-w-0">
      <span
        class="font-mono text-xs font-bold text-gold-600 bg-navy-800 px-2.5 py-1 rounded shrink-0"
        data-theme-fixed
      >
        DIV {divisionLetter}
      </span>
      <div class="min-w-0">
        <h3 class="font-serif text-base font-bold text-navy-900 truncate">
          {shortTitle || title}
        </h3>
      </div>
    </div>
    <div class="flex items-center gap-3 shrink-0 ml-3">
      <span class="font-mono text-sm font-bold text-navy-900">${spending}B</span>
      <span class="text-xs font-mono text-navy-400 hidden sm:inline">({percent.toFixed(1)}%)</span>
      <Icon
        name="chevron-right"
        size={16}
        class="text-navy-400 transition-transform duration-200 group-open:rotate-90"
      />
    </div>
  </summary>

  <div class="division-content px-4 pb-4 md:px-5 md:pb-5 border-t border-gold-200">
    <!-- Percentage bar -->
    <div class="mt-3 mb-3">
      <div class="flex items-center justify-between text-xs text-navy-500 mb-1">
        <span>Portion of total package</span>
        <span class="font-mono">{percent.toFixed(1)}%</span>
      </div>
      <div class="h-2 bg-cream-300 rounded-full overflow-hidden">
        <div
          class="h-full bg-gradient-to-r from-gold-500 to-gold-600 rounded-full"
          style={`width: ${Math.min(percent * 2, 100)}%`}
        >
        </div>
      </div>
    </div>

    {shortTitle && shortTitle !== title && <p class="text-xs text-navy-500 italic mb-2">{title}</p>}

    {
      description && (
        <p class="font-serif text-sm text-navy-700 leading-relaxed mb-3">{description}</p>
      )
    }

    {
      content && (
        <div class="prose prose-sm max-w-none text-navy-700">
          <Fragment set:html={content} />
        </div>
      )
    }

    <slot />

    <!-- Quick stats -->
    <div class="mt-3 pt-3 border-t border-gold-200 flex flex-wrap gap-3 text-xs text-navy-500">
      <span class="flex items-center gap-1">
        <Icon name="banknote" size={14} class="text-gold-600" />
        ${spending}B appropriated
      </span>
      <span class="flex items-center gap-1">
        <Icon name="clipboard-list" size={14} class="text-gold-600" />
        Division {divisionLetter} of package
      </span>
    </div>
  </div>
</details>

<style>
  /* Hide default marker */
  summary::-webkit-details-marker,
  summary::marker {
    display: none;
  }

  /* Smooth content reveal */
  .division-content {
    animation: divSlideDown 0.2s ease-out;
  }

  @keyframes divSlideDown {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
