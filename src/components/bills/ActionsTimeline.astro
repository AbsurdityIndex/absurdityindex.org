---
import Icon from '../ui/Icon.astro';

interface Action {
  date: Date;
  text: string;
  chamber?: 'house' | 'senate' | 'both';
  type?: string;
}

interface Props {
  actions?: Action[];
  maxItems?: number;
}

const { actions = [], maxItems = 10 } = Astro.props;

if (!actions || actions.length === 0) {
  return null;
}

// Sort by date descending (most recent first)
const sortedActions = [...actions].sort(
  (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),
);

const displayActions = sortedActions.slice(0, maxItems);
const hasMore = actions.length > maxItems;

function getChamberColor(chamber?: string) {
  if (chamber === 'house') return 'bg-blue-100 text-blue-700 border-blue-200';
  if (chamber === 'senate') return 'bg-purple-100 text-purple-700 border-purple-200';
  return 'bg-navy-100 text-navy-600 border-navy-200';
}

function getChamberLabel(chamber?: string) {
  if (chamber === 'house') return 'House';
  if (chamber === 'senate') return 'Senate';
  return 'Both';
}

function getActionIcon(text: string) {
  const t = text.toLowerCase();
  if (t.includes('signed') || t.includes('became law') || t.includes('enacted'))
    return 'check-circle';
  if (t.includes('vetoed') || t.includes('failed') || t.includes('died')) return 'x-circle';
  if (t.includes('passed') || t.includes('agreed to')) return 'vote';
  if (t.includes('referred') || t.includes('committee')) return 'building';
  if (t.includes('introduced') || t.includes('sponsor')) return 'file-text';
  if (t.includes('amendment')) return 'edit';
  if (t.includes('floor') || t.includes('debate')) return 'message-square';
  if (t.includes('president') || t.includes('executive')) return 'landmark';
  return 'clock';
}

function getActionIconColor(text: string) {
  const t = text.toLowerCase();
  if (
    t.includes('signed') ||
    t.includes('became law') ||
    t.includes('enacted') ||
    t.includes('passed')
  )
    return 'text-green-600';
  if (t.includes('vetoed') || t.includes('failed') || t.includes('died')) return 'text-red-600';
  return 'text-navy-500';
}
---

<div class="bg-cream-100 border border-gold-300 rounded-lg p-5">
  <h4 class="font-serif font-bold text-navy-900 text-sm mb-4 flex items-center gap-2">
    <Icon name="clock" size={16} class="text-gold-600" />
    Legislative Actions
    <span class="ml-auto text-xs font-sans font-medium text-navy-500">
      {actions.length} total
    </span>
  </h4>

  <div class="space-y-3">
    {
      displayActions.map((action, i) => (
        <div class="flex gap-3 group">
          {/* Timeline connector */}
          <div class="flex flex-col items-center">
            <div
              class={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${i === 0 ? 'bg-gold-200' : 'bg-cream-200'}`}
            >
              <Icon
                name={getActionIcon(action.text)}
                size={12}
                class={getActionIconColor(action.text)}
              />
            </div>
            {i < displayActions.length - 1 && <div class="w-0.5 flex-1 bg-gold-200 mt-1" />}
          </div>

          {/* Action content */}
          <div class="flex-1 pb-3 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <time class="text-xs font-mono text-navy-500">
                {new Date(action.date).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric',
                  timeZone: 'UTC',
                })}
              </time>
              {action.chamber && (
                <span
                  class={`text-xs px-1.5 py-0.5 rounded border ${getChamberColor(action.chamber)}`}
                >
                  {getChamberLabel(action.chamber)}
                </span>
              )}
            </div>
            <p class="text-sm text-navy-700 leading-snug">{action.text}</p>
          </div>
        </div>
      ))
    }
  </div>

  {
    hasMore && (
      <div class="mt-4 pt-4 border-t border-gold-200 text-center">
        <p class="text-xs text-navy-500">
          Showing {maxItems} of {actions.length} actions
        </p>
      </div>
    )
  }
</div>
