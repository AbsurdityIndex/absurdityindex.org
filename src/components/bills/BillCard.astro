---
import BillNumberBadge from './BillNumberBadge.astro';
import BillTypeBadge from './BillTypeBadge.astro';
import BillStageBadge from './BillStageBadge.astro';
import AbsurdityMeter from './AbsurdityMeter.astro';
import Icon from '../ui/Icon.astro';

interface Props {
  bill: {
    id: string;
    data: {
      title: string;
      billNumber: string;
      billType: 'sensible' | 'absurd' | 'real';
      category: string;
      sponsor: string;
      status: string;
      summary: string;
      dateIntroduced: Date;
      tags?: string[];
      featured?: boolean;
      absurdityIndex?: number;
      pairedBillId?: string;
    };
  };
  variant?: 'default' | 'real-grid';
}

const { bill, variant = 'default' } = Astro.props;
const { data } = bill;

const isReal = data.billType === 'real';
const isRealGridCard = variant === 'real-grid' && isReal;
const detailHref = isReal ? `/bills/${bill.id}` : `/not-bills/${bill.id}`;

// Extract just the name portion from "Rep. Name (R-ST)" format
const sponsorName = data.sponsor.replace(/\s*\([^)]+\)\s*$/, '').trim();
const sponsorParty = data.sponsor.match(/\(([^)]+)\)/)?.[1] || '';

const formattedDate = new Date(data.dateIntroduced).toLocaleDateString('en-US', {
  month: 'short',
  year: 'numeric',
});

// Category slug for link
const categorySlug = data.category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-');

function getAbsurdityScoreClasses(score: number): string {
  if (score <= 3) return 'bg-green-100 text-green-800 border-green-200';
  if (score <= 6) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
  if (score <= 8) return 'bg-orange-100 text-orange-800 border-orange-200';
  return 'bg-red-100 text-red-800 border-red-200';
}
---

<article
  class:list={[
    'group relative min-h-full overflow-hidden bg-white shadow-sm transition-all duration-200 hover:shadow-lg',
    isRealGridCard ? 'rounded-xl hover:-translate-y-0.5' : 'rounded-lg',
    data.featured
      ? 'ring-2 ring-gold-400 border border-gold-400'
      : isRealGridCard
        ? 'border border-gold-300 hover:border-gold-500'
        : 'border border-gold-200 hover:border-gold-400',
  ]}
>
  {/* Top accent bar */}
  <div class:list={[
    'h-1',
    data.featured ? 'bg-gradient-to-r from-gold-400 via-gold-500 to-gold-400' : isReal ? 'bg-navy-600' : 'bg-green-600',
  ]} />

  {data.featured && (
    <div class="absolute top-1 right-0 bg-gold-500 text-navy-900 text-xs font-bold px-3 py-0.5 rounded-bl-lg font-mono">
      FEATURED
    </div>
  )}

  <div class:list={['p-4 min-[375px]:p-5', isRealGridCard && 'space-y-0.5']}>
    {/* Header row: badges */}
    <div class="mb-2 flex items-center justify-between gap-2">
      <BillNumberBadge billNumber={data.billNumber} />
      {isRealGridCard && data.absurdityIndex ? (
        <span class:list={[
          'inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-mono font-bold min-[375px]:text-xs',
          getAbsurdityScoreClasses(data.absurdityIndex),
        ]}>
          <Icon name="zap" size={11} />
          {data.absurdityIndex}/10
        </span>
      ) : (
        <BillTypeBadge billType={data.billType} />
      )}
    </div>

    {/* Status badge */}
    {isReal && (
      <div class="mb-2.5 min-[375px]:mb-3">
        <BillStageBadge status={data.status} size="sm" />
      </div>
    )}

    {/* Title */}
    <h3 class:list={[
      'mb-2 font-serif font-bold leading-snug text-navy-900 transition-colors group-hover:text-navy-700',
      isRealGridCard
        ? 'text-[1.06rem] min-[375px]:text-lg min-[430px]:text-xl'
        : 'text-[1.04rem] min-[375px]:text-lg',
    ]}>
      <a
        href={detailHref}
        class="after:absolute after:inset-0"
      >
        {data.title}
      </a>
    </h3>

    {/* Summary */}
    <p class:list={[
      'mb-3.5 text-[13px] leading-relaxed text-navy-600 min-[375px]:mb-4 min-[375px]:text-sm',
      isRealGridCard ? 'line-clamp-3' : 'line-clamp-2',
    ]}>
      {data.summary}
    </p>

    {/* Absurdity meter for real bills */}
    {isReal && data.absurdityIndex && (
      <div class="mb-3.5 min-[375px]:mb-4">
        <AbsurdityMeter score={data.absurdityIndex} compact />
      </div>
    )}

    {/* Footer */}
    <div class="space-y-2 border-t border-cream-200 pt-2.5 min-[375px]:pt-3">
      {/* Sponsor row */}
      <div class="flex items-center gap-2 text-[13px] min-[375px]:text-sm">
        <div class="w-5 h-5 rounded-full bg-navy-100 flex items-center justify-center flex-shrink-0">
          <Icon name="user" size={12} class="text-navy-600" />
        </div>
        <span class="text-navy-700 font-medium truncate" title={data.sponsor}>
          {sponsorName}
        </span>
        {sponsorParty && (
          <span class="text-[11px] text-navy-500 font-mono flex-shrink-0 min-[375px]:text-xs">({sponsorParty})</span>
        )}
      </div>

      {/* Category and date row */}
      <div class="flex flex-col items-start gap-2 min-[430px]:flex-row min-[430px]:items-center min-[430px]:justify-between">
        <a
          href={`/category/${categorySlug}`}
          class="relative z-10 inline-flex items-center gap-1 rounded-full bg-cream-100 px-2.5 py-1 text-[11px] font-medium text-navy-600 transition-colors hover:bg-cream-200 min-[375px]:text-xs"
        >
          <Icon name="tag" size={10} class="text-navy-400" />
          {data.category}
        </a>
        <div class="flex items-center gap-1.5 text-[11px] text-navy-500 min-[375px]:text-xs">
          <Icon name="calendar" size={12} class="text-navy-400" />
          <time datetime={data.dateIntroduced.toISOString()}>{formattedDate}</time>
        </div>
      </div>
    </div>
  </div>
</article>
