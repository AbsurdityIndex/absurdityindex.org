---
/**
 * TheGist - Editorial summary card that leads the bill page
 *
 * This is the hook â€” the interesting, accessible take on what the bill does.
 * Prominently displayed at the top of bill detail pages.
 */
import Icon from '../ui/Icon.astro';
import { getTier } from '../../utils/absurdity-tiers';

interface Props {
  theGist: string;
  whyItMatters?: string;
  absurdityIndex?: number;
}

const { theGist, whyItMatters, absurdityIndex } = Astro.props;

// Convert markdown links [text](url) to anchor tags
const renderLinks = (text: string) =>
  text.replace(
    /\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g,
    '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-navy-800 underline hover:text-gold-600">$1</a>'
  );

// Map tier colors to tone badge styling
const toneColors: Record<string, string> = {
  'tier-green': 'text-green-600 bg-green-50',
  'tier-yellow': 'text-amber-600 bg-amber-50',
  'tier-orange': 'text-orange-600 bg-orange-50',
  'tier-red': 'text-red-600 bg-red-50',
};

const tone = absurdityIndex
  ? (() => {
      const tier = getTier(absurdityIndex);
      return { label: tier.name, color: toneColors[tier.color.drawerClass] };
    })()
  : null;
---

<div class="the-gist relative">
  {/* Editorial badge */}
  <div class="flex items-center gap-2 mb-3">
    <div class="flex items-center gap-2 px-3 py-1 bg-navy-800 text-gold-400 rounded-full">
      <Icon name="sparkles" size={14} />
      <span class="text-xs font-mono font-semibold uppercase tracking-wider">The Gist</span>
    </div>
    {tone && (
      <span class:list={['text-xs font-sans font-medium px-2 py-1 rounded-full', tone.color]}>
        {tone.label}
      </span>
    )}
  </div>

  {/* Main editorial content */}
  <blockquote class="relative pl-4 border-l-4 border-gold-500">
    <p class="text-lg md:text-xl font-serif text-navy-900 leading-relaxed" set:html={renderLinks(theGist)}>
    </p>
  </blockquote>

  {/* Why it matters - if provided */}
  {whyItMatters && (
    <div class="mt-4 flex items-start gap-3 p-3 bg-cream-200 rounded-lg">
      <div class="flex-shrink-0 w-6 h-6 rounded-full bg-navy-100 flex items-center justify-center mt-0.5">
        <Icon name="info" size={12} class="text-navy-600" />
      </div>
      <div>
        <p class="text-xs font-sans font-semibold text-navy-600 uppercase tracking-wide mb-1">
          Why It Matters
        </p>
        <p class="text-sm font-sans text-navy-700 leading-relaxed" set:html={renderLinks(whyItMatters)}>
        </p>
      </div>
    </div>
  )}
</div>

<style>
  .the-gist blockquote p::before {
    content: '"';
    position: absolute;
    left: -0.5rem;
    top: -0.5rem;
    font-size: 3rem;
    font-family: Georgia, serif;
    color: var(--color-gold-300);
    line-height: 1;
    pointer-events: none;
  }
</style>
