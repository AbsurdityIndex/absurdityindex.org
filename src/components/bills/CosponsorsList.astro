---
import Icon from '../ui/Icon.astro';

interface Cosponsor {
  name: string;
  party?: string;
  state?: string;
  district?: number;
  dateAdded?: Date;
  url?: string;
}

interface Props {
  cosponsors?: (string | Cosponsor)[];
  cosponsorCount?: number;
  maxItems?: number;
}

const { cosponsors = [], cosponsorCount, maxItems = 12 } = Astro.props;

// Handle mixed array of strings and objects
const normalizedCosponsors: Cosponsor[] = cosponsors
  .filter(c => c && typeof c !== 'string' || (typeof c === 'string' && !c.includes('cosponsor')))
  .map(c => typeof c === 'string' ? { name: c } : c);

const total = cosponsorCount ?? normalizedCosponsors.length;

if (total === 0) {
  return null;
}

const displayCosponsors = normalizedCosponsors.slice(0, maxItems);
const hasMore = normalizedCosponsors.length > maxItems;

function getPartyColor(party?: string) {
  if (!party) return 'bg-navy-100 text-navy-600';
  const p = party.toUpperCase();
  if (p === 'D' || p === 'DEMOCRAT' || p === 'DEMOCRATIC') return 'bg-blue-100 text-blue-700';
  if (p === 'R' || p === 'REPUBLICAN') return 'bg-red-100 text-red-700';
  if (p === 'I' || p === 'INDEPENDENT') return 'bg-purple-100 text-purple-700';
  return 'bg-navy-100 text-navy-600';
}

function formatParty(party?: string) {
  if (!party) return '';
  const p = party.toUpperCase();
  if (p === 'D' || p === 'DEMOCRAT' || p === 'DEMOCRATIC') return 'D';
  if (p === 'R' || p === 'REPUBLICAN') return 'R';
  if (p === 'I' || p === 'INDEPENDENT') return 'I';
  return p;
}
---

<div class="bg-cream-100 border border-gold-300 rounded-lg p-5">
  <h4 class="font-serif font-bold text-navy-900 text-sm mb-4 flex items-center gap-2">
    <Icon name="users" size={16} class="text-gold-600" />
    Cosponsors
    <span class="ml-auto text-xs font-sans font-medium text-navy-500">
      {total} total
    </span>
  </h4>

  {displayCosponsors.length > 0 ? (
    <div class="flex flex-wrap gap-2">
      {displayCosponsors.map((cosponsor) => (
        <div class="inline-flex items-center gap-1.5 px-2 py-1 bg-white rounded border border-gold-200 text-sm">
          {cosponsor.party && (
            <span class={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${getPartyColor(cosponsor.party)}`}>
              {formatParty(cosponsor.party)}
            </span>
          )}
          <span class="text-navy-800">{cosponsor.name}</span>
          {cosponsor.state && (
            <span class="text-xs text-navy-500">({cosponsor.state})</span>
          )}
        </div>
      ))}
    </div>
  ) : (
    <p class="text-sm text-navy-500 italic">
      {total} cosponsors, but detailed data is not available.
    </p>
  )}

  {hasMore && (
    <div class="mt-4 pt-4 border-t border-gold-200 text-center">
      <p class="text-xs text-navy-500">
        Showing {maxItems} of {normalizedCosponsors.length} cosponsors
      </p>
    </div>
  )}
</div>
