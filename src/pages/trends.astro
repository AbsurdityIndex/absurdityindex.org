---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allBills = await getCollection('bills');
const realBills = allBills.filter(b => b.data.billType === 'real');

// --- 1. Average Absurdity by Category ---
const categoryMap = new Map<string, number[]>();
for (const bill of realBills) {
  const cat = bill.data.category;
  const score = bill.data.absurdityIndex ?? 0;
  if (!categoryMap.has(cat)) categoryMap.set(cat, []);
  categoryMap.get(cat)!.push(score);
}
const categoryAverages = [...categoryMap.entries()]
  .map(([category, scores]) => ({
    category,
    avg: scores.reduce((a, b) => a + b, 0) / scores.length,
    count: scores.length,
  }))
  .sort((a, b) => b.avg - a.avg);

// --- 2. Absurdity Distribution (1-10) ---
const distribution = Array.from({ length: 10 }, (_, i) => ({
  score: i + 1,
  count: realBills.filter(b => b.data.absurdityIndex === i + 1).length,
}));
const maxDistCount = Math.max(...distribution.map(d => d.count), 1);

// --- 3. Bills by Status ---
const statusMap = new Map<string, number>();
for (const bill of realBills) {
  const s = bill.data.status;
  statusMap.set(s, (statusMap.get(s) ?? 0) + 1);
}
const statusEntries = [...statusMap.entries()]
  .map(([status, count]) => ({ status, count }))
  .sort((a, b) => b.count - a.count);
const totalBills = realBills.length;

// Pie chart math
const statusColors = ['#d4a843', '#1e3a5f', '#F97316', '#16a34a', '#DC2626', '#EAB308'];
let cumulativePercent = 0;
const pieSlices = statusEntries.map((entry, i) => {
  const percent = entry.count / totalBills;
  const startAngle = cumulativePercent * 2 * Math.PI;
  cumulativePercent += percent;
  const endAngle = cumulativePercent * 2 * Math.PI;
  const largeArc = percent > 0.5 ? 1 : 0;
  const x1 = 50 + 40 * Math.cos(startAngle - Math.PI / 2);
  const y1 = 50 + 40 * Math.sin(startAngle - Math.PI / 2);
  const x2 = 50 + 40 * Math.cos(endAngle - Math.PI / 2);
  const y2 = 50 + 40 * Math.sin(endAngle - Math.PI / 2);
  return {
    ...entry,
    color: statusColors[i % statusColors.length],
    path: totalBills === entry.count
      ? `M 50 10 A 40 40 0 1 1 49.99 10 Z`
      : `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`,
    percent,
  };
});

// --- Helper: color by score ---
function scoreColor(score: number): string {
  if (score <= 3) return '#16a34a';
  if (score <= 6) return '#EAB308';
  if (score <= 8) return '#F97316';
  return '#DC2626';
}

// --- Cost calculations ---
const members = 535;
const baseSalary = 174000;
const totalSalary = 93090000;
const avgSessionDays = 147;
const costPerSessionDay = Math.round(totalSalary / avgSessionDays);
const costPerCalendarDay = Math.round(totalSalary / 365);
const legislativeBranchBudget = 6.9; // billions
---

<BaseLayout title="Absurdity Trends" description="Data-driven analytics of congressional absurdity. Charts, stats, and the cost of legislative theater.">
  <main class="bg-parchment min-h-screen">

    <!-- Hero -->
    <section class="bg-navy-900 py-12 sm:py-16">
      <div class="max-w-5xl mx-auto px-4 text-center">
        <h1 class="font-serif text-3xl sm:text-4xl lg:text-5xl text-gold-400 font-bold">
          Absurdity Trends
        </h1>
        <p class="mt-4 text-gold-300/80 font-sans text-lg max-w-2xl mx-auto">
          The numbers don't lie &mdash; but Congress might. A data-driven look at legislative absurdity, because someone has to keep score.
        </p>
        <p class="mt-2 text-navy-400 font-mono text-sm">
          Tracking {realBills.length} real bill{realBills.length !== 1 ? 's' : ''} and counting
        </p>
      </div>
    </section>

    <div class="max-w-6xl mx-auto px-4 py-10 sm:py-14 space-y-14">

      <!-- ============================================ -->
      <!-- 1. Average Absurdity by Category             -->
      <!-- ============================================ -->
      <section>
        <h2 class="font-serif text-2xl sm:text-3xl text-navy-900 font-bold mb-2">
          Average Absurdity by Category
        </h2>
        <p class="text-navy-700 font-sans text-sm mb-6">
          Which policy areas produce the most absurd legislation? Higher is worse (or funnier, depending on your perspective).
        </p>

        <div class="bg-white rounded-lg border border-navy-200 p-4 sm:p-6 shadow-sm">
          <svg viewBox={`0 0 600 ${categoryAverages.length * 52 + 10}`} class="w-full" role="img" aria-label="Horizontal bar chart of average absurdity by category">
            {categoryAverages.map((cat, i) => {
              const barWidth = (cat.avg / 10) * 380;
              const y = i * 52 + 5;
              return (
                <g>
                  <text x="0" y={y + 22} font-size="13" fill="#1e3a5f" font-family="sans-serif" font-weight="600">
                    {cat.category}
                  </text>
                  <text x="0" y={y + 38} font-size="10" fill="#64748b" font-family="sans-serif">
                    {cat.count} bill{cat.count !== 1 ? 's' : ''}
                  </text>
                  <rect x="180" y={y + 8} width={barWidth} height="28" rx="4" fill={scoreColor(cat.avg)} opacity="0.85" />
                  <text x={185 + barWidth} y={y + 27} font-size="14" fill="#1e3a5f" font-family="monospace" font-weight="700">
                    {cat.avg.toFixed(1)}
                  </text>
                </g>
              );
            })}
          </svg>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- 2. Absurdity Distribution                    -->
      <!-- ============================================ -->
      <section>
        <h2 class="font-serif text-2xl sm:text-3xl text-navy-900 font-bold mb-2">
          Absurdity Distribution
        </h2>
        <p class="text-navy-700 font-sans text-sm mb-6">
          How many bills at each absurdity level? The chart Congress doesn't want you to see.
        </p>

        <div class="bg-white rounded-lg border border-navy-200 p-4 sm:p-6 shadow-sm">
          <svg viewBox="0 0 600 260" class="w-full" role="img" aria-label="Bar chart showing distribution of absurdity scores from 1 to 10">
            {/* Y-axis label */}
            <text x="10" y="15" font-size="11" fill="#64748b" font-family="sans-serif">Bills</text>
            {distribution.map((d, i) => {
              const barHeight = d.count > 0 ? (d.count / maxDistCount) * 170 : 0;
              const x = 40 + i * 54;
              const barY = 200 - barHeight;
              return (
                <g>
                  {d.count > 0 && (
                    <rect x={x} y={barY} width="40" height={barHeight} rx="4" fill={scoreColor(d.score)} opacity="0.85" />
                  )}
                  {d.count > 0 && (
                    <text x={x + 20} y={barY - 6} text-anchor="middle" font-size="12" fill="#1e3a5f" font-family="monospace" font-weight="700">
                      {d.count}
                    </text>
                  )}
                  {d.count === 0 && (
                    <rect x={x} y={196} width="40" height="4" rx="2" fill="#e2e8f0" />
                  )}
                  <text x={x + 20} y={225} text-anchor="middle" font-size="13" fill="#1e3a5f" font-family="monospace" font-weight="600">
                    {d.score}
                  </text>
                </g>
              );
            })}
            {/* X-axis line */}
            <line x1="35" y1="203" x2="585" y2="203" stroke="#cbd5e1" stroke-width="1" />
            <text x="300" y="250" text-anchor="middle" font-size="11" fill="#64748b" font-family="sans-serif">Absurdity Score</text>
          </svg>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- 3. Bills by Status                           -->
      <!-- ============================================ -->
      <section>
        <h2 class="font-serif text-2xl sm:text-3xl text-navy-900 font-bold mb-2">
          Bills by Status
        </h2>
        <p class="text-navy-700 font-sans text-sm mb-6">
          Where legislation goes to live, die, or linger indefinitely in committee purgatory.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Pie Chart */}
          <div class="bg-white rounded-lg border border-navy-200 p-4 sm:p-6 shadow-sm flex items-center justify-center">
            <svg viewBox="0 0 100 100" class="w-48 h-48 sm:w-56 sm:h-56" role="img" aria-label="Pie chart of bill statuses">
              {pieSlices.map((slice) => (
                <path d={slice.path} fill={slice.color} stroke="white" stroke-width="0.5" />
              ))}
              <circle cx="50" cy="50" r="18" fill="white" />
              <text x="50" y="48" text-anchor="middle" font-size="10" fill="#1e3a5f" font-family="monospace" font-weight="700">
                {totalBills}
              </text>
              <text x="50" y="57" text-anchor="middle" font-size="5" fill="#64748b" font-family="sans-serif">
                bills
              </text>
            </svg>
          </div>

          {/* Legend / stat cards */}
          <div class="space-y-3">
            {pieSlices.map((slice) => (
              <div class="flex items-center gap-3 bg-white rounded-lg border border-navy-200 p-3 shadow-sm">
                <div class="w-4 h-4 rounded-sm shrink-0" style={`background-color: ${slice.color}`}></div>
                <div class="flex-1">
                  <span class="font-sans text-sm text-navy-900 font-semibold">{slice.status}</span>
                </div>
                <span class="font-mono text-lg text-navy-900 font-bold">{slice.count}</span>
                <span class="font-mono text-xs text-navy-500">{(slice.percent * 100).toFixed(0)}%</span>
              </div>
            ))}
          </div>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- 4. Cost to Taxpayers                         -->
      <!-- ============================================ -->
      <section>
        <h2 class="font-serif text-2xl sm:text-3xl text-navy-900 font-bold mb-2">
          Cost to Taxpayers
        </h2>
        <p class="text-navy-700 font-sans text-sm mb-6">
          What your elected officials cost you, broken down to an uncomfortable level of specificity.
        </p>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* Card: Members */}
          <div class="bg-white rounded-lg border-2 border-navy-200 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-navy-900">{members}</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Members of Congress</p>
            <p class="font-sans text-xs text-navy-500 mt-1">435 House + 100 Senate</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              All pulling in the same salary since 2009
            </p>
          </div>

          {/* Card: Base Salary */}
          <div class="bg-white rounded-lg border-2 border-navy-200 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-navy-900">${baseSalary.toLocaleString()}</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Base Salary / Year</p>
            <p class="font-sans text-xs text-navy-500 mt-1">Unchanged since 2009 &mdash; no raise</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              Speaker gets $223,500. Leadership gets $193,400.
            </p>
          </div>

          {/* Card: Total Congressional Salary */}
          <div class="bg-white rounded-lg border-2 border-gold-400 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-gold-600">$93.1M</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Total Congressional Salary / Year</p>
            <p class="font-sans text-xs text-navy-500 mt-1">Just salaries. Not staff. Not benefits.</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              The price of gridlock, simplified
            </p>
          </div>

          {/* Card: Session Days */}
          <div class="bg-white rounded-lg border-2 border-navy-200 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-navy-900">~{avgSessionDays}</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Avg. House Session Days / Year</p>
            <p class="font-sans text-xs text-navy-500 mt-1">Senate averages ~165 days</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              The rest is "district work." Sure.
            </p>
          </div>

          {/* Card: Cost Per Session Day */}
          <div class="bg-white rounded-lg border-2 border-navy-200 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-navy-900">${costPerSessionDay.toLocaleString()}</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Cost Per Session Day</p>
            <p class="font-sans text-xs text-navy-500 mt-1">Salary cost when Congress is in session</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              That's just the salaries, not the catering
            </p>
          </div>

          {/* Card: Cost Per Calendar Day */}
          <div class="bg-white rounded-lg border-2 border-navy-200 p-5 shadow-sm text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-navy-900">${costPerCalendarDay.toLocaleString()}</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">Cost Per Calendar Day</p>
            <p class="font-sans text-xs text-navy-500 mt-1">Yes, including weekends and holidays</p>
            <p class="font-sans text-xs text-gold-600 mt-2 italic">
              Your money never takes a recess
            </p>
          </div>
        </div>

        {/* Post office naming callout */}
        <div class="mt-6 bg-navy-800 rounded-lg p-6 sm:p-8 border border-navy-700 text-center">
          <p class="font-sans text-xs uppercase tracking-widest text-gold-500 mb-3">Fun Fact</p>
          <p class="font-serif text-xl sm:text-2xl text-gold-400 font-bold leading-snug max-w-3xl mx-auto">
            Every post office naming ceremony costs taxpayers approximately
            <span class="text-gold-300 font-mono text-2xl sm:text-3xl"> ${costPerSessionDay.toLocaleString()}</span>
            in congressional salary time.
          </p>
          <p class="font-sans text-sm text-gold-300/60 mt-3">
            And they do it a <em>lot</em>. In the 117th Congress, over 60 bills were just naming post offices.
          </p>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- 5. Your Tax Dollars at Work                  -->
      <!-- ============================================ -->
      <section>
        <h2 class="font-serif text-2xl sm:text-3xl text-navy-900 font-bold mb-2">
          Your Tax Dollars at Work
        </h2>
        <p class="text-navy-700 font-sans text-sm mb-6">
          A few more numbers to contextualize the machine.
        </p>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {/* Legislative Branch Budget */}
          <div class="bg-navy-900 rounded-lg p-6 text-center border border-navy-700">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-gold-400">${legislativeBranchBudget}B</p>
            <p class="font-sans text-sm text-gold-300 mt-1 font-semibold">
              Legislative Branch Budget (FY2024)
            </p>
            <p class="font-sans text-xs text-gold-300/60 mt-2">
              Includes salaries, staff, the Capitol Police, the Library of Congress, and the printing of bills nobody reads.
            </p>
          </div>

          {/* Staff costs */}
          <div class="bg-navy-900 rounded-lg p-6 text-center border border-navy-700">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-gold-400">~$2.9B</p>
            <p class="font-sans text-sm text-gold-300 mt-1 font-semibold">
              House & Senate Office Allowances
            </p>
            <p class="font-sans text-xs text-gold-300/60 mt-2">
              For staffers who write the bills their bosses haven't read and won't vote on.
            </p>
          </div>

          {/* Post office namings */}
          <div class="bg-white rounded-lg border-2 border-gold-400 p-6 text-center">
            <p class="font-mono text-4xl sm:text-5xl font-bold text-gold-600">60+</p>
            <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">
              Post Office Namings (117th Congress)
            </p>
            <p class="font-sans text-xs text-navy-500 mt-2">
              The most bipartisan achievement in modern history: agreeing on building names.
            </p>
          </div>

          {/* Average absurdity */}
          <div class="bg-white rounded-lg border-2 border-gold-400 p-6 text-center">
            {(() => {
              const scores = realBills.map(b => b.data.absurdityIndex ?? 0).filter(s => s > 0);
              const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
              return (
                <>
                  <p class="font-mono text-4xl sm:text-5xl font-bold" style={`color: ${scoreColor(avg)}`}>
                    {avg.toFixed(1)}
                  </p>
                  <p class="font-sans text-sm text-navy-700 mt-1 font-semibold">
                    Average Absurdity Score
                  </p>
                  <p class="font-sans text-xs text-navy-500 mt-2">
                    Across all {scores.length} rated bills. A perfectly mediocre democracy.
                  </p>
                </>
              );
            })()}
          </div>
        </div>
      </section>

      <!-- Methodology note -->
      <section class="text-center pb-4">
        <div class="border-t border-navy-200 pt-8">
          <p class="font-sans text-xs text-navy-500 max-w-2xl mx-auto leading-relaxed">
            <strong class="text-navy-700">Methodology:</strong> Absurdity scores are assigned by the Absurdity Index editorial board on a scale of 1&ndash;10 based on legislative substance, naming creativity, and general affront to democratic principles. Salary data from the Congressional Research Service. Session day averages from the Library of Congress. Cost figures are simplified for editorial clarity.
          </p>
        </div>
      </section>

    </div>
  </main>
</BaseLayout>
