---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import OfficialSeal from '../../../components/ui/OfficialSeal.astro';
import Icon from '../../../components/ui/Icon.astro';
---

<BaseLayout
  title="VoteChain POC Oversight Dashboard"
  description="POC oversight dashboard: simulated VoteChain ledger events, bulletin board STHs, fraud flags, and tally publishing."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'dashboard'],
  }}
>
  <main class="bg-parchment min-h-screen">
    <section class="relative bg-navy-900 py-10 sm:py-14">
      <div class="max-w-6xl mx-auto px-4 text-center relative z-10">
        <div class="flex justify-center">
          <OfficialSeal size="90" />
        </div>
        <p class="text-sm text-gold-500 font-mono uppercase tracking-widest mt-5 mb-2">EWP POC</p>
        <h1 class="font-serif text-3xl sm:text-4xl text-gold-400 font-bold">Oversight Dashboard</h1>
        <p class="mt-3 text-gold-300/80 font-sans text-base max-w-4xl mx-auto">
          Monitor local bulletin board state, signed tree heads, simulated VoteChain anchors, and
          fraud flags.
        </p>
      </div>
    </section>

    <div class="max-w-6xl mx-auto px-4 py-10 sm:py-12 space-y-8">
      <section class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">Verified</p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-verified">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">
            Crypto-Conflict
          </p>
          <p class="font-serif text-3xl text-red-600 font-bold" id="m-conflict">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">
            Bulletin Board Leaves
          </p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-leaves">0</p>
        </div>
        <div class="bg-white rounded-lg border border-navy-200 p-6 text-center shadow-md">
          <p class="text-navy-500 font-mono text-xs uppercase tracking-wider mb-2">Ledger Events</p>
          <p class="font-serif text-3xl text-navy-900 font-bold" id="m-events">0</p>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="clipboard-list" class="text-gold-600" />
            Controls
          </h2>
          <div class="flex flex-wrap gap-2">
            <a
              href="/votechain/poc/vote"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="vote" class="text-navy-700" size={18} />
              Voting Client
            </a>
            <a
              href="/votechain/poc/verify"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="shield" class="text-navy-700" size={18} />
              Verify Receipt
            </a>
            <a
              href="/votechain/poc"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="home" class="text-navy-700" size={18} />
              POC Home
            </a>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button
            id="refresh"
            class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
            type="button"
          >
            <Icon name="repeat" class="text-gold-300" size={18} />
            Refresh
          </button>
          <button
            id="publish-tally"
            class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-4 py-2 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
            type="button"
          >
            <Icon name="check" class="text-navy-900" size={18} />
            Publish POC Tally
          </button>
          <button
            id="export"
            class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-4 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            type="button"
          >
            <Icon name="archive" class="text-navy-700" size={18} />
            Export Snapshot
          </button>
          <button
            id="reset"
            class="inline-flex items-center gap-2 rounded-md bg-red-600 px-4 py-2 text-white font-sans text-sm font-semibold hover:bg-red-700 transition-colors"
            type="button"
          >
            <Icon name="x" class="text-white" size={18} />
            Reset
          </button>
        </div>

        <p id="controls-status" class="mt-3 text-sm text-navy-600"></p>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="bb">
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="git-commit" class="text-gold-600" />
            Latest BB STH
          </h2>
          <p class="text-navy-600 text-sm mt-2">
            Signed Tree Heads (STHs) are the append-only checkpoints that are anchored on VoteChain.
          </p>
          <pre
            class="mt-4 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="latest-sth">Loading...</code></pre>
        </div>
        <div class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="file-check" class="text-gold-600" />
            Published Tally (POC)
          </h2>
          <p class="text-navy-600 text-sm mt-2">
            This demo tally decrypts ballots locally. Production EWP requires threshold decryption +
            public proofs.
          </p>
          <pre
            class="mt-4 rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="tally-json">Not published.</code></pre>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="list" class="text-gold-600" />
            VoteChain Ledger Events
          </h2>
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">newest first</p>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-navy-800 text-cream-100">
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider">Type</th>
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Recorded</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider">Tx</th>
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Payload</th
                >
              </tr>
            </thead>
            <tbody id="events-body" class="bg-white"></tbody>
          </table>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="inbox" class="text-gold-600" />
            Bulletin Board Leaves
          </h2>
          <p class="text-xs font-mono text-navy-500 uppercase tracking-widest">newest first</p>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-navy-800 text-cream-100">
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Leaf Hash</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Received</th
                >
                <th class="text-left px-3 py-2 font-sans text-xs uppercase tracking-wider"
                  >Ballot Hash</th
                >
              </tr>
            </thead>
            <tbody id="leaves-body" class="bg-white"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    import { getDashboardSnapshot, publishTally, resetPocState } from '../../../votechain-poc/poc';

    const mVerified = document.getElementById('m-verified') as HTMLElement;
    const mConflict = document.getElementById('m-conflict') as HTMLElement;
    const mLeaves = document.getElementById('m-leaves') as HTMLElement;
    const mEvents = document.getElementById('m-events') as HTMLElement;

    const latestSthEl = document.getElementById('latest-sth') as HTMLElement;
    const tallyEl = document.getElementById('tally-json') as HTMLElement;

    const eventsBody = document.getElementById('events-body') as HTMLElement;
    const leavesBody = document.getElementById('leaves-body') as HTMLElement;

    const refreshBtn = document.getElementById('refresh') as HTMLButtonElement;
    const publishBtn = document.getElementById('publish-tally') as HTMLButtonElement;
    const exportBtn = document.getElementById('export') as HTMLButtonElement;
    const resetBtn = document.getElementById('reset') as HTMLButtonElement;
    const statusEl = document.getElementById('controls-status') as HTMLElement;

    function short(value: unknown, n: number = 10) {
      if (!value || typeof value !== 'string') return '';
      if (value.length <= n * 2 + 3) return value;
      return `${value.slice(0, n)}...${value.slice(-n)}`;
    }

    function td(text: string, className?: string) {
      const cell = document.createElement('td');
      cell.className = className || 'px-3 py-2 border-b border-navy-100 align-top';
      cell.textContent = text;
      return cell;
    }

    function tdCode(text: string) {
      const cell = document.createElement('td');
      cell.className =
        'px-3 py-2 border-b border-navy-100 align-top font-mono text-xs text-navy-800';
      cell.textContent = text;
      return cell;
    }

    function render(snapshot: any) {
      mVerified.textContent = String(snapshot.metrics.verified);
      mConflict.textContent = String(snapshot.metrics.crypto_conflict);
      mLeaves.textContent = String(snapshot.bb.leaf_count);
      mEvents.textContent = String(snapshot.vcl.event_count);

      latestSthEl.textContent = snapshot.bb.latest_sth
        ? JSON.stringify(snapshot.bb.latest_sth, null, 2)
        : 'None';
      tallyEl.textContent = snapshot.tally
        ? JSON.stringify(snapshot.tally, null, 2)
        : 'Not published.';

      eventsBody.replaceChildren();
      for (const evt of snapshot.events) {
        const tr = document.createElement('tr');
        tr.appendChild(
          td(evt.type, 'px-3 py-2 border-b border-navy-100 align-top font-mono text-xs'),
        );
        tr.appendChild(
          td(evt.recorded_at, 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );
        tr.appendChild(tdCode(short(evt.tx_id, 8)));
        tr.appendChild(tdCode(short(JSON.stringify(evt.payload), 24)));
        eventsBody.appendChild(tr);
      }

      leavesBody.replaceChildren();
      for (const leaf of snapshot.leaves) {
        const tr = document.createElement('tr');
        const received = leaf.payload?.received_at ? String(leaf.payload.received_at) : '';
        const ballotHash = leaf.payload?.encrypted_ballot?.ballot_hash
          ? String(leaf.payload.encrypted_ballot.ballot_hash)
          : '';
        tr.appendChild(tdCode(short(leaf.leaf_hash, 12)));
        tr.appendChild(
          td(received, 'px-3 py-2 border-b border-navy-100 align-top text-xs text-navy-700'),
        );
        tr.appendChild(tdCode(short(ballotHash, 12)));
        leavesBody.appendChild(tr);
      }
    }

    async function refresh() {
      const snapshot = await getDashboardSnapshot();
      render(snapshot);
      statusEl.textContent = `Updated: ${new Date().toLocaleString()}`;
    }

    refreshBtn?.addEventListener('click', () => refresh());

    publishBtn?.addEventListener('click', async () => {
      publishBtn.disabled = true;
      statusEl.textContent = 'Publishing tally...';
      try {
        const res = await publishTally();
        if ('error' in res) {
          statusEl.textContent = res.error;
        } else {
          statusEl.textContent = 'Tally published and anchored.';
        }
      } finally {
        publishBtn.disabled = false;
        await refresh();
      }
    });

    exportBtn?.addEventListener('click', async () => {
      const snapshot = await getDashboardSnapshot();
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `votechain-poc-snapshot-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    resetBtn?.addEventListener('click', () => {
      resetPocState();
      window.location.reload();
    });

    refresh();
  </script>
</BaseLayout>
