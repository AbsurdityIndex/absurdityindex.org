---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import OfficialSeal from '../../../components/ui/OfficialSeal.astro';
import Divider from '../../../components/ui/Divider.astro';
import Icon from '../../../components/ui/Icon.astro';
---

<BaseLayout
  title="VoteChain POC Receipt Verification"
  description="Verify a VoteChain EWP cast receipt: signatures, bulletin board inclusion, and VoteChain anchor."
  ogType="article"
  article={{
    publishedTime: '2026-02-08',
    author: 'Absurdity Index',
    section: 'Policy',
    tags: ['votechain', 'ewp', 'poc', 'verification'],
  }}
>
  <main class="bg-parchment min-h-screen">
    <section class="relative bg-navy-900 py-10 sm:py-14">
      <div class="max-w-5xl mx-auto px-4 text-center relative z-10">
        <div class="flex justify-center">
          <OfficialSeal size="90" />
        </div>
        <p class="text-sm text-gold-500 font-mono uppercase tracking-widest mt-5 mb-2">EWP POC</p>
        <h1 class="font-serif text-3xl sm:text-4xl text-gold-400 font-bold">
          Receipt Verification
        </h1>
        <p class="mt-3 text-gold-300/80 font-sans text-base max-w-3xl mx-auto">
          After casting your ballot, you receive a signed receipt. This page lets you
          independently verify that your vote was actually recorded &mdash; that it wasn't
          silently dropped, altered, or excluded from the count.
        </p>
      </div>
    </section>

    <div class="max-w-5xl mx-auto px-4 py-10 sm:py-12 space-y-8">
      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
            <Icon name="receipt" class="text-gold-600" />
            Cast Receipt
          </h2>
          <div class="flex flex-wrap gap-2">
            <a
              href="/votechain/poc/vote"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="vote" class="text-navy-700" size={18} />
              Voting Client
            </a>
            <a
              href="/votechain/poc/dashboard"
              class="inline-flex items-center gap-2 rounded-md border border-navy-200 bg-white px-3 py-2 text-navy-800 font-sans text-sm font-semibold hover:border-gold-500 hover:shadow-sm transition-all"
            >
              <Icon name="bar-chart" class="text-navy-700" size={18} />
              Dashboard
            </a>
          </div>
        </div>

        <p class="text-navy-600 text-sm mt-2">
          <strong>What to do:</strong> Your most recent receipt has been auto-loaded from your
          browser's <span class="font-mono">localStorage</span> below. Click <em>Verify</em>
          to run the checks. Each check independently confirms a different layer of the system
          recorded your ballot correctly.
        </p>
        <p class="text-navy-600 text-sm mt-1.5">
          <strong>What the checks mean:</strong> The verifier confirms that (1) the receipt's
          signature is authentic, (2) the bulletin board's tree head was properly signed,
          (3) your ballot is provably included in the Merkle tree, and (4) a matching anchor
          event exists on the VoteChain ledger. All checks must pass for full confidence.
        </p>
        <p class="text-navy-500 text-xs mt-1.5 italic">
          All verification runs locally in your browser against the state in
          <span class="font-mono">localStorage</span>. Nothing is sent to any server.
        </p>
        <p class="text-navy-600 text-sm mt-2">
          <strong>In a real election:</strong> Verification would check your receipt against
          independently operated services &mdash; the bulletin board (run by the election
          authority), the VoteChain ledger (a distributed, append-only record), and the
          signed tree heads (published publicly for anyone to audit). Because these services
          are separate and monitored by multiple parties, a single compromised server could
          not forge a valid receipt or hide a missing ballot.
        </p>

        <div class="mt-4 flex flex-wrap gap-2">
          <button
            id="load-last"
            class="inline-flex items-center gap-2 rounded-md bg-navy-800 px-4 py-2 text-gold-200 font-sans text-sm font-semibold hover:bg-navy-700 transition-colors"
            type="button"
          >
            <Icon name="inbox" class="text-gold-300" size={18} />
            Load Last Receipt
          </button>
          <button
            id="verify-btn"
            class="inline-flex items-center gap-2 rounded-md bg-gold-500 px-4 py-2 text-navy-900 font-sans text-sm font-semibold hover:bg-gold-400 transition-colors"
            type="button"
          >
            <Icon name="shield" class="text-navy-900" size={18} />
            Verify
          </button>
        </div>

        <textarea
          id="receipt-input"
          class="mt-4 w-full min-h-[220px] rounded-lg border border-navy-200 bg-cream-50 p-4 font-mono text-xs text-navy-900 focus:outline-none focus:ring-2 focus:ring-gold-400"
          placeholder="Paste cast_receipt JSON here..."></textarea>

        <Divider withSeal={false} />

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
              Verification Result
            </p>
            <div id="verify-summary" class="rounded-lg border border-navy-200 bg-white p-4">
              <p class="text-navy-600 text-sm">Waiting for receipt.</p>
            </div>
          </div>
          <div>
            <p class="text-[11px] font-mono uppercase tracking-widest text-navy-500 mb-2">
              Inclusion Proof
            </p>
            <pre
              class="rounded-lg bg-navy-800 text-cream-100 p-4 overflow-x-auto text-xs leading-relaxed font-mono"><code id="proof-json">Waiting...</code></pre>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-xl border border-navy-200 p-6 sm:p-8 shadow-md">
        <h2 class="font-serif text-xl text-navy-900 font-bold flex items-center gap-2">
          <Icon name="info" class="text-gold-600" />
          Notes
        </h2>
        <div class="mt-3 text-navy-700 text-sm space-y-2">
          <p>
            <strong>Why this matters:</strong> In traditional elections, you trust officials to
            count your ballot correctly. With VoteChain, every voter gets a cryptographic receipt
            that lets them independently prove their vote was included &mdash; without revealing
            how they voted. This is called "recorded-as-cast" verification.
          </p>
          <p>
            <strong>POC limitation:</strong> This demo runs entirely in your browser, so the
            bulletin board and ledger are local &mdash; stored in
            <span class="font-mono">localStorage</span>. In a production system, these would
            be independent network services hosted and monitored by multiple parties, making
            tampering far more difficult to conceal. Anyone could run the same verification
            tool against the live services and get the same result.
          </p>
        </div>
      </section>
    </div>
  </main>

  <script>
    import { verifyReceipt } from '../../../votechain-poc/poc';

    const receiptInput = document.getElementById('receipt-input') as HTMLTextAreaElement;
    const loadLastBtn = document.getElementById('load-last') as HTMLButtonElement;
    const verifyBtn = document.getElementById('verify-btn') as HTMLButtonElement;
    const summaryEl = document.getElementById('verify-summary') as HTMLElement;
    const proofEl = document.getElementById('proof-json') as HTMLElement;

    function el(tag: keyof HTMLElementTagNameMap, className?: string, text?: string) {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (text !== undefined) node.textContent = text;
      return node;
    }

    function badge(status: 'ok' | 'fail') {
      const ok = status === 'ok';
      return el(
        'span',
        ok
          ? 'inline-flex items-center rounded-full bg-green-600/15 px-2.5 py-1 text-xs font-semibold text-green-700'
          : 'inline-flex items-center rounded-full bg-red-600/15 px-2.5 py-1 text-xs font-semibold text-red-700',
        ok ? 'OK' : 'FAIL',
      );
    }

    // Auto-load last receipt on page load
    (function autoLoadReceipt() {
      const raw = localStorage.getItem('votechain_poc_last_receipt');
      if (raw) {
        receiptInput.value = raw;
        const notice = el('p', 'text-sm text-gold-700 font-sans mt-2', 'Loaded your last cast receipt automatically.');
        notice.id = 'auto-load-notice';
        receiptInput.parentElement?.insertBefore(notice, receiptInput.nextSibling);
      }
    })();

    loadLastBtn?.addEventListener('click', () => {
      const raw = localStorage.getItem('votechain_poc_last_receipt');
      if (!raw) return;
      receiptInput.value = raw;
      if (!document.getElementById('auto-load-notice')) {
        const notice = el('p', 'text-sm text-gold-700 font-sans mt-2', 'Receipt loaded.');
        notice.id = 'auto-load-notice';
        receiptInput.parentElement?.insertBefore(notice, receiptInput.nextSibling);
      }
    });

    verifyBtn?.addEventListener('click', async () => {
      summaryEl.replaceChildren();
      proofEl.textContent = 'Working...';

      let receipt: unknown;
      try {
        receipt = JSON.parse(receiptInput.value);
      } catch (err) {
        summaryEl.appendChild(el('p', 'text-red-700 text-sm', `Invalid JSON: ${String(err)}`));
        proofEl.textContent = 'N/A';
        return;
      }

      const result = await verifyReceipt(receipt as any);

      const header = el('div', 'flex items-center justify-between gap-3 flex-wrap');
      header.appendChild(el('p', 'font-sans text-sm font-semibold text-navy-900', 'Overall'));
      header.appendChild(badge(result.status));
      summaryEl.appendChild(header);

      const list = el('div', 'mt-3 space-y-2');
      for (const check of result.checks) {
        const row = el(
          'div',
          'flex items-start justify-between gap-3 border-t border-navy-100 pt-2',
        );
        const left = el('div', '');
        left.appendChild(el('p', 'font-mono text-xs text-navy-800', check.name));
        if (check.details) left.appendChild(el('p', 'text-xs text-navy-500 mt-0.5', check.details));
        row.appendChild(left);
        row.appendChild(badge(check.status));
        list.appendChild(row);
      }
      summaryEl.appendChild(list);

      proofEl.textContent = result.inclusion_proof
        ? JSON.stringify(result.inclusion_proof, null, 2)
        : 'N/A';
    });
  </script>
</BaseLayout>
