---
import BaseLayout from '../../layouts/BaseLayout.astro';
import OfficialSeal from '../../components/ui/OfficialSeal.astro';
import { getCollection } from 'astro:content';

const bills = await getCollection('bills');
const omnibusBills = bills
  .filter(b => b.data.isOmnibus && b.data.omnibusData)
  .sort((a, b) => b.data.dateIntroduced.getTime() - a.data.dateIntroduced.getTime());

// Calculate totals
const totalSpending = omnibusBills.reduce((sum, b) => sum + (b.data.omnibusData?.totalSpending || 0), 0);
const totalPages = omnibusBills.reduce((sum, b) => sum + (b.data.omnibusData?.pageCount || 0), 0);
---

<BaseLayout
  title="Omnibus Bills"
  description="Explore massive omnibus appropriations bills ‚Äî the legislative sausage factories where thousands of pages and trillions of dollars go to be negotiated in secret."
>
  <main class="bg-parchment min-h-screen">
    <!-- Hero Section -->
    <section class="bg-navy-900 py-16">
      <div class="max-w-5xl mx-auto px-4 text-center">
        <OfficialSeal size="100" />
        <p class="text-sm text-gold-500 font-mono uppercase tracking-widest mt-6 mb-2">The Legislative Sausage Factory</p>
        <h1 class="font-serif text-4xl md:text-5xl text-gold-400 font-bold mb-4">
          Omnibus Bills
        </h1>
        <p class="text-gold-300/80 max-w-2xl mx-auto text-lg">
          Where thousands of pages of legislation get bundled together at the last minute,
          voted on sight-unseen, and passed in the dead of night.
        </p>
      </div>
    </section>

    <div class="max-w-5xl mx-auto px-4 py-12">
      <!-- Stats Bar -->
      <div class="bg-cream-100 rounded-lg border border-gold-300 p-6 mb-10">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
          <div>
            <div class="font-mono text-3xl font-bold text-navy-900">{omnibusBills.length}</div>
            <div class="text-sm text-navy-600">Omnibus Bills</div>
          </div>
          <div>
            <div class="font-mono text-3xl font-bold text-navy-900">${totalSpending.toFixed(1)}T</div>
            <div class="text-sm text-navy-600">Total Spending</div>
          </div>
          <div>
            <div class="font-mono text-3xl font-bold text-navy-900">{totalPages.toLocaleString()}</div>
            <div class="text-sm text-navy-600">Combined Pages</div>
          </div>
          <div>
            <div class="font-mono text-3xl font-bold text-navy-900">~{Math.round(totalPages / 4000)}</div>
            <div class="text-sm text-navy-600">Reams of Paper</div>
          </div>
        </div>
      </div>

      <!-- What is an Omnibus -->
      <div class="bg-parchment border border-gold-300 rounded-lg p-8 mb-10">
        <h2 class="font-serif text-2xl font-bold text-navy-900 mb-4 flex items-center gap-3">
          <span class="text-gold-500">‚ùì</span>
          What is an Omnibus Bill?
        </h2>
        <div class="prose prose-navy max-w-none">
          <p class="text-navy-700 leading-relaxed">
            An <strong>omnibus bill</strong> combines multiple appropriations bills into a single massive package,
            typically thousands of pages long. Instead of passing 12 separate spending bills through the normal
            committee process, Congress bundles them together at the last minute ‚Äî often with a government
            shutdown deadline looming.
          </p>
          <p class="text-navy-700 leading-relaxed">
            Because of their size and timing, omnibus bills are virtually impossible to read before voting.
            They frequently contain <strong>policy riders</strong> ‚Äî unrelated provisions that couldn't pass
            on their own merits, hidden among the spending provisions like presents nobody asked for.
          </p>
        </div>
      </div>

      {omnibusBills.length === 0 ? (
        <div class="text-center py-16 bg-cream-100 rounded-lg border border-gold-300">
          <span class="text-6xl mb-4 block">üìö</span>
          <h2 class="font-serif text-2xl text-navy-900 font-bold mb-2">No Omnibus Bills Yet</h2>
          <p class="text-navy-600">
            We're working on adding comprehensive omnibus bill analysis. Check back soon.
          </p>
        </div>
      ) : (
        <div class="space-y-6">
          {omnibusBills.map((bill) => {
            const d = bill.data;
            const omnibus = d.omnibusData!;
            const formattedDate = d.dateIntroduced.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
            });

            return (
              <a
                href={`/omnibus/${bill.id}`}
                class="block bg-white rounded-lg border-2 border-gold-300 shadow-lg overflow-hidden hover:shadow-xl hover:border-gold-500 transition-all group"
              >
                <div class="bg-navy-800 px-6 py-3 flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <span class="font-mono text-gold-400">{d.billNumber}</span>
                    <span class="px-2 py-0.5 bg-red-700 text-cream-100 text-xs font-mono rounded">OMNIBUS</span>
                  </div>
                  <span class="text-gold-400/70 text-sm">{formattedDate}</span>
                </div>

                <div class="p-6">
                  <h2 class="font-serif text-xl font-bold text-navy-900 group-hover:text-gold-700 transition-colors mb-3">
                    {d.title}
                  </h2>
                  <p class="text-navy-600 text-sm line-clamp-2 mb-4">{d.summary}</p>

                  <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gold-200">
                    <div class="text-center">
                      <div class="font-mono text-xl font-bold text-navy-900">${omnibus.totalSpending}B</div>
                      <div class="text-xs text-navy-500">Spending</div>
                    </div>
                    <div class="text-center">
                      <div class="font-mono text-xl font-bold text-navy-900">{omnibus.pageCount.toLocaleString()}</div>
                      <div class="text-xs text-navy-500">Pages</div>
                    </div>
                    <div class="text-center">
                      <div class="font-mono text-xl font-bold text-navy-900">{omnibus.divisions.length}</div>
                      <div class="text-xs text-navy-500">Divisions</div>
                    </div>
                  </div>

                  {d.absurdityIndex && (
                    <div class="mt-4 flex items-center justify-center gap-2">
                      <span class="text-sm text-navy-500">Absurdity:</span>
                      <div class="flex gap-0.5">
                        {[...Array(10)].map((_, i) => (
                          <div
                            class={`w-3 h-6 rounded-sm ${i < d.absurdityIndex! ? 'bg-gradient-to-t from-gold-600 to-red-600' : 'bg-cream-300'}`}
                          />
                        ))}
                      </div>
                      <span class="font-mono font-bold text-navy-900">{d.absurdityIndex}/10</span>
                    </div>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      )}

      <!-- Navigation -->
      <div class="text-center mt-12">
        <a href="/bills" class="text-navy-600 hover:text-gold-600 font-serif transition-colors">
          &larr; Back to All Bills
        </a>
      </div>
    </div>
  </main>
</BaseLayout>
