---
import BaseLayout from '../layouts/BaseLayout.astro';
import Divider from '../components/ui/Divider.astro';
import BillCard from '../components/bills/BillCard.astro';
import { getCollection } from 'astro:content';

const allBills = await getCollection('bills');
const recentBills = allBills
  .sort((a, b) => b.data.dateIntroduced.getTime() - a.data.dateIntroduced.getTime())
  .slice(0, 3);
---

<BaseLayout
  title="What Did Congress Do Today?"
  description="Live congressional floor and committee activity for today, sourced from official public feeds."
>
  <div class="mx-auto max-w-6xl px-4 py-10">
    <header class="mb-8 text-center">
      <p class="mb-2 font-mono text-xs uppercase tracking-[0.2em] text-gold-600">Live Daily Dispatch</p>
      <h1 class="font-serif text-3xl font-bold text-navy-900 md:text-4xl">What Did Congress Do Today?</h1>
      <p class="mt-3 font-sans text-sm text-navy-600">
        Official public sources, updated throughout the legislative day.
      </p>
    </header>

    <section class="rounded-xl border-2 border-gold-300 bg-cream-100/90 p-5 shadow-sm md:p-7">
      <p id="today-live-date" class="font-serif text-xl text-navy-800">Loading current day data...</p>

      <div id="today-live-loading" class="mt-4 rounded-lg bg-cream-200 p-3 font-sans text-sm text-navy-700">
        Fetching House floor proceedings, Senate floor schedule, and committee calendars.
      </div>

      <div id="today-live-error" class="mt-4 hidden rounded-lg border border-red-600/40 bg-red-600/10 p-3 font-sans text-sm text-red-700">
        Unable to load live congressional data right now.
      </div>

      <div id="today-live-content" class="mt-5 hidden space-y-8">
        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Today&apos;s Summary</h2>
          <p id="today-live-headline" class="mt-2 font-sans text-base text-navy-800"></p>
          <p id="today-live-deck" class="mt-2 rounded-lg border border-gold-200 bg-cream-100 px-3 py-2 font-serif text-base italic text-navy-800"></p>
          <ul id="today-live-bullets" class="mt-3 space-y-2 font-sans text-sm text-navy-700"></ul>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Chamber Activity</h2>
          <div class="mt-3 grid grid-cols-1 gap-4 md:grid-cols-2">
            <article class="rounded-lg border border-gold-200 bg-cream-100 p-4">
              <p class="font-mono text-xs uppercase tracking-[0.16em] text-gold-700">House</p>
              <p id="today-live-house-status" class="mt-1 font-serif text-2xl font-bold text-navy-900">-</p>
              <p id="today-live-house-line1" class="mt-2 font-sans text-sm text-navy-700">-</p>
              <p id="today-live-house-line2" class="mt-1 font-sans text-sm text-navy-700">-</p>
            </article>

            <article class="rounded-lg border border-gold-200 bg-cream-100 p-4">
              <p class="font-mono text-xs uppercase tracking-[0.16em] text-gold-700">Senate</p>
              <p id="today-live-senate-status" class="mt-1 font-serif text-2xl font-bold text-navy-900">-</p>
              <p id="today-live-senate-line1" class="mt-2 font-sans text-sm text-navy-700">-</p>
              <p id="today-live-senate-line2" class="mt-1 font-sans text-sm text-navy-700">-</p>
            </article>
          </div>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Committee Meetings</h2>
          <p id="today-live-committee-count" class="mt-1 font-sans text-sm text-navy-600"></p>
          <ul id="today-live-committees" class="mt-3 space-y-3"></ul>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">House Floor Agenda This Week</h2>
          <p id="today-live-weekof" class="mt-1 font-sans text-sm text-navy-600"></p>
          <div id="today-live-week-sections" class="mt-3 space-y-4"></div>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Source Health</h2>
          <ul id="today-live-sources" class="mt-2 space-y-1 font-sans text-sm text-navy-700"></ul>
        </section>
      </div>
    </section>

    <Divider withSeal={true} />

    <section class="mt-8">
      <div class="mb-3 flex items-center justify-between gap-3">
        <h2 class="font-serif text-2xl font-bold text-navy-900">Recent Bills in the Index</h2>
        <a href="/bills" class="font-sans text-sm text-navy-600 underline hover:text-gold-600">
          Browse all real bills
        </a>
      </div>

      {recentBills.length > 0 ? (
        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
          {recentBills.map((bill) => (
            <BillCard bill={bill} />
          ))}
        </div>
      ) : (
        <p class="font-sans text-sm text-navy-600">No bills available in the local content collection.</p>
      )}
    </section>
  </div>
</BaseLayout>

<script>
  const dateEl = document.getElementById('today-live-date');
  const loadingEl = document.getElementById('today-live-loading');
  const errorEl = document.getElementById('today-live-error');
  const contentEl = document.getElementById('today-live-content');

  const headlineEl = document.getElementById('today-live-headline');
  const deckEl = document.getElementById('today-live-deck');
  const bulletsEl = document.getElementById('today-live-bullets');

  const houseStatusEl = document.getElementById('today-live-house-status');
  const houseLine1El = document.getElementById('today-live-house-line1');
  const houseLine2El = document.getElementById('today-live-house-line2');

  const senateStatusEl = document.getElementById('today-live-senate-status');
  const senateLine1El = document.getElementById('today-live-senate-line1');
  const senateLine2El = document.getElementById('today-live-senate-line2');

  const committeeCountEl = document.getElementById('today-live-committee-count');
  const committeesEl = document.getElementById('today-live-committees');

  const weekOfEl = document.getElementById('today-live-weekof');
  const weekSectionsEl = document.getElementById('today-live-week-sections');

  const sourcesEl = document.getElementById('today-live-sources');

  function truncate(text, max = 220) {
    if (!text || text.length <= max) return text || '';
    return `${text.slice(0, max - 1).trim()}...`;
  }

  function statusClass(status) {
    if (/adjourned/i.test(status || '')) return 'text-red-700';
    if (/session/i.test(status || '')) return 'text-green-700';
    return 'text-navy-900';
  }

  function listItems(target, values) {
    target.innerHTML = '';
    values.forEach((value) => {
      const li = document.createElement('li');
      li.textContent = value;
      target.appendChild(li);
    });
  }

  function renderMeetings(meetings) {
    committeesEl.innerHTML = '';

    if (!Array.isArray(meetings) || meetings.length === 0) {
      const empty = document.createElement('li');
      empty.className = 'rounded-lg border border-gold-200 bg-cream-100 p-3 font-sans text-sm text-navy-700';
      empty.textContent = 'No House or Senate committee meetings are listed for today.';
      committeesEl.appendChild(empty);
      return;
    }

    meetings.slice(0, 12).forEach((meeting) => {
      const item = document.createElement('li');
      item.className = 'rounded-lg border border-gold-200 bg-cream-100 p-3';

      const heading = document.createElement('p');
      heading.className = 'font-sans text-xs uppercase tracking-[0.14em] text-gold-700';
      const time = meeting.time ? `${meeting.time} - ` : '';
      heading.textContent = `${time}${meeting.chamber || 'Committee'}`;

      const committee = document.createElement('p');
      committee.className = 'mt-1 font-serif text-base font-bold text-navy-900';
      committee.textContent = meeting.committee || meeting.title || 'Committee meeting';

      const detail = document.createElement('p');
      detail.className = 'mt-1 font-sans text-sm text-navy-700';
      const detailParts = [];
      if (meeting.focus) detailParts.push(`Focus: ${meeting.focus}.`);
      if (Number.isFinite(meeting.relatedBillCount) && meeting.relatedBillCount > 0) {
        detailParts.push(`${meeting.relatedBillCount} related bill${meeting.relatedBillCount === 1 ? '' : 's'}.`);
      }
      if (Number.isFinite(meeting.relatedNominationCount) && meeting.relatedNominationCount > 0) {
        detailParts.push(`${meeting.relatedNominationCount} nomination item${meeting.relatedNominationCount === 1 ? '' : 's'}.`);
      }
      if (meeting.isClosed) {
        detailParts.push('Closed session.');
      }
      const location = meeting.location ? `Location: ${meeting.location}.` : '';
      const fallback = meeting.title || meeting.type || 'Meeting';
      const detailText = detailParts.length > 0
        ? `${detailParts.join(' ')} ${location}`.trim()
        : `${fallback}${location ? ` (${meeting.location})` : ''}`;
      detail.textContent = truncate(detailText, 200);

      item.appendChild(heading);
      item.appendChild(committee);
      item.appendChild(detail);
      committeesEl.appendChild(item);
    });
  }

  function renderWeekAgenda(agenda) {
    weekSectionsEl.innerHTML = '';

    if (!agenda || !Array.isArray(agenda.sections) || agenda.sections.length === 0) {
      weekOfEl.textContent = 'No House floor agenda sections were parsed.';
      return;
    }

    weekOfEl.textContent = agenda.weekOf
      ? `Week of ${agenda.weekOf}`
      : 'Current House floor agenda';

    agenda.sections.slice(0, 3).forEach((section) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'rounded-lg border border-gold-200 bg-cream-100 p-3';

      const title = document.createElement('h3');
      title.className = 'font-serif text-lg font-bold text-navy-900';
      title.textContent = section.section || 'Agenda section';

      const ul = document.createElement('ul');
      ul.className = 'mt-2 space-y-1 font-sans text-sm text-navy-700';

      (section.items || []).slice(0, 6).forEach((item) => {
        const li = document.createElement('li');
        const bill = item.bill ? `${item.bill}: ` : '';
        li.textContent = truncate(`${bill}${item.title || ''}`, 170);
        ul.appendChild(li);
      });

      wrapper.appendChild(title);
      wrapper.appendChild(ul);
      weekSectionsEl.appendChild(wrapper);
    });
  }

  function renderSources(sources) {
    if (!Array.isArray(sources) || sources.length === 0) {
      listItems(sourcesEl, ['No source health metadata found.']);
      return;
    }

    const sourceLabel = (key) => {
      switch (key) {
        case 'officialLiveFeeds':
        case 'congressApiKey':
          return 'Official live feeds';
        default:
          return key || 'Source';
      }
    };

    const sourceStatus = (source) => {
      const status = String(source?.status || '').toLowerCase();
      const rawError = String(source?.error || '');
      const safeError = /missing key/i.test(rawError)
        ? 'Not configured in this deployment.'
        : (rawError || 'Unknown issue.');

      if (status === 'ok') return 'operational';
      if (status === 'unavailable') return `unavailable (${safeError})`;
      return `degraded (${safeError})`;
    };

    listItems(
      sourcesEl,
      sources.map((source) => {
        return `${sourceLabel(source?.key)}: ${sourceStatus(source)}`;
      })
    );
  }

  async function requestTodayData() {
    const endpoints = ['/api/today.json', '/api/today-fallback.json'];
    let lastError;

    for (const endpoint of endpoints) {
      try {
        const response = await fetch(endpoint, {
          headers: { Accept: 'application/json' },
        });
        if (!response.ok) {
          lastError = new Error(`${endpoint} returned HTTP ${response.status}`);
          continue;
        }
        const data = await response.json();
        return data;
      } catch (error) {
        lastError = error;
      }
    }

    throw lastError || new Error('Unable to load today data from available endpoints.');
  }

  async function loadTodayLive() {
    try {
      const data = await requestTodayData();

      dateEl.textContent = data?.today?.label || 'Today';
      headlineEl.textContent = data?.summary?.headline || '';
      deckEl.textContent =
        data?.summary?.deck ||
        'Satire desk is waiting for proceedings to escalate beyond procedural verbs.';
      listItems(bulletsEl, Array.isArray(data?.summary?.bullets) ? data.summary.bullets : []);

      const house = data?.chambers?.house || {};
      houseStatusEl.textContent = house.status || 'No update';
      houseStatusEl.className = `mt-1 font-serif text-2xl font-bold ${statusClass(house.status)}`;
      houseLine1El.textContent = house.latestAction?.text
        ? `${house.latestAction.time ? `${house.latestAction.time}: ` : ''}${truncate(house.latestAction.text, 190)}`
        : 'No House floor action posted yet.';
      houseLine2El.textContent = house.nextConvene
        ? `Next House meeting: ${house.nextConvene}`
        : 'Next meeting not posted.';

      const senate = data?.chambers?.senate || {};
      senateStatusEl.textContent = senate.status || 'No update';
      senateStatusEl.className = `mt-1 font-serif text-2xl font-bold ${statusClass(senate.status)}`;
      senateLine1El.textContent = senate.previousSummary
        ? truncate(senate.previousSummary, 210)
        : 'No Senate floor summary posted yet.';
      senateLine2El.textContent = senate.nextConvene
        ? `Next Senate meeting: ${senate.nextConvene}`
        : 'Next meeting not posted.';

      const committeeTotal = data?.committees?.totalToday;
      committeeCountEl.textContent = Number.isFinite(committeeTotal)
        ? `${committeeTotal} House and Senate meetings listed today.`
        : 'Committee counts are unavailable.';
      renderMeetings(data?.committees?.meetings);

      renderWeekAgenda(data?.houseWeekAgenda);
      renderSources(data?.sources);

      loadingEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
    } catch (_error) {
      loadingEl.classList.add('hidden');
      contentEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
    }
  }

  loadTodayLive();
</script>
