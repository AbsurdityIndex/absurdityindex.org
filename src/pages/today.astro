---
import BaseLayout from '../layouts/BaseLayout.astro';
import Divider from '../components/ui/Divider.astro';
import BillCard from '../components/bills/BillCard.astro';
import { getCollection } from 'astro:content';

const allBills = await getCollection('bills');
const recentBills = allBills
  .sort((a, b) => b.data.dateIntroduced.getTime() - a.data.dateIntroduced.getTime())
  .slice(0, 3);
---

<BaseLayout
  title="What Did Congress Do Today?"
  description="Live congressional floor and committee activity for today, sourced from official public feeds."
  ogImage="/og/today.png"
>
  <div class="mx-auto max-w-6xl px-4 py-10">
    <header class="mb-8">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="mb-2 font-mono text-xs uppercase tracking-[0.2em] text-gold-600">
            Live Public Sources
          </p>
          <h1 class="font-serif text-3xl font-bold text-navy-900 md:text-4xl">
            What Did Congress Do Today?
          </h1>
          <p class="mt-3 font-sans text-sm text-navy-600">
            Official public sources, updated throughout the legislative day.
          </p>
        </div>
        <a
          href="/dispatch"
          class="hidden shrink-0 rounded-lg bg-navy-900 px-5 py-2.5 font-sans text-sm font-medium text-cream-100 transition-colors hover:bg-navy-800 md:inline-block"
        >
          Full Daily Dispatch
        </a>
      </div>
    </header>

    <section class="rounded-xl border-2 border-gold-300 bg-cream-100/90 p-5 shadow-sm md:p-7">
      <p id="today-live-date" class="font-serif text-xl text-navy-800">
        Loading current day data...
      </p>

      <div
        id="today-live-loading"
        class="mt-4 rounded-lg bg-cream-200 p-3 font-sans text-sm text-navy-700"
      >
        Fetching House floor proceedings, Senate floor schedule, and committee calendars.
      </div>

      <div
        id="today-live-error"
        class="mt-4 hidden rounded-lg border border-red-600/40 bg-red-600/10 p-3 font-sans text-sm text-red-700"
      >
        Unable to load live congressional data right now.
      </div>

      <div id="today-live-content" class="mt-5 hidden space-y-8">
        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Today&apos;s Summary</h2>
          <p id="today-live-headline" class="mt-2 font-sans text-base text-navy-800"></p>
          <p
            id="today-live-deck"
            class="mt-2 rounded-lg border border-gold-200 bg-cream-100 px-3 py-2 font-serif text-base italic text-navy-800"
          >
          </p>
          <div id="today-live-bullets" class="mt-4 grid grid-cols-1 gap-3 md:grid-cols-2"></div>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Chamber Activity</h2>
          <div class="mt-3 grid grid-cols-1 gap-4 md:grid-cols-2">
            <article class="rounded-lg border border-gold-200 bg-cream-100 p-4">
              <p class="font-mono text-xs uppercase tracking-[0.16em] text-gold-700">House</p>
              <p
                id="today-live-house-status"
                class="mt-1 font-serif text-2xl font-bold text-navy-900"
              >
                -
              </p>
              <p id="today-live-house-line1" class="mt-2 font-sans text-sm text-navy-700">-</p>
              <p id="today-live-house-line2" class="mt-1 font-sans text-sm text-navy-700">-</p>
            </article>

            <article class="rounded-lg border border-gold-200 bg-cream-100 p-4">
              <p class="font-mono text-xs uppercase tracking-[0.16em] text-gold-700">Senate</p>
              <p
                id="today-live-senate-status"
                class="mt-1 font-serif text-2xl font-bold text-navy-900"
              >
                -
              </p>
              <p id="today-live-senate-line1" class="mt-2 font-sans text-sm text-navy-700">-</p>
              <p id="today-live-senate-line2" class="mt-1 font-sans text-sm text-navy-700">-</p>
            </article>
          </div>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">Committee Meetings</h2>
          <p id="today-live-committee-count" class="mt-1 font-sans text-sm text-navy-600"></p>
          <ul id="today-live-committees" class="mt-3 grid list-none grid-cols-1 gap-3 p-0 md:grid-cols-2"></ul>
        </section>

        <section>
          <h2 class="font-serif text-2xl font-bold text-navy-900">House Floor Agenda This Week</h2>
          <p id="today-live-weekof" class="mt-1 font-sans text-sm text-navy-600"></p>
          <div id="today-live-week-sections" class="mt-3 space-y-4"></div>
        </section>

        <section>
          <details>
            <summary class="cursor-pointer font-serif text-lg text-navy-600 hover:text-navy-900">
              Source Health
            </summary>
            <ul id="today-live-sources" class="mt-2 space-y-1 font-sans text-sm text-navy-700"></ul>
          </details>
        </section>
      </div>
    </section>

    <Divider withSeal={true} />

    <section class="mt-8">
      <div class="mb-3 flex items-center justify-between gap-3">
        <h2 class="font-serif text-2xl font-bold text-navy-900">Recent Bills in the Index</h2>
        <a href="/bills" class="font-sans text-sm text-navy-600 underline hover:text-gold-600">
          Browse all real bills
        </a>
      </div>

      {
        recentBills.length > 0 ? (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
            {recentBills.map((bill) => (
              <BillCard bill={bill} />
            ))}
          </div>
        ) : (
          <p class="font-sans text-sm text-navy-600">
            No bills available in the local content collection.
          </p>
        )
      }
    </section>
  </div>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    type TodaySource = {
      key?: string;
      status?: string;
      error?: string;
    };

    type TodayMeeting = {
      time?: string;
      chamber?: string;
      committee?: string;
      title?: string;
      type?: string;
      focus?: string;
      location?: string;
      relatedBillCount?: number;
      relatedNominationCount?: number;
      isClosed?: boolean;
    };

    type WeekAgendaItem = {
      bill?: string;
      title?: string;
    };

    type WeekAgendaSection = {
      section?: string;
      items?: WeekAgendaItem[];
    };

    type WeekAgenda = {
      weekOf?: string;
      sections?: WeekAgendaSection[];
    };

    const dateEl = document.getElementById('today-live-date');
    const loadingEl = document.getElementById('today-live-loading');
    const errorEl = document.getElementById('today-live-error');
    const contentEl = document.getElementById('today-live-content');

    const headlineEl = document.getElementById('today-live-headline');
    const deckEl = document.getElementById('today-live-deck');
    const bulletsEl = document.getElementById('today-live-bullets');

    const houseStatusEl = document.getElementById('today-live-house-status');
    const houseLine1El = document.getElementById('today-live-house-line1');
    const houseLine2El = document.getElementById('today-live-house-line2');

    const senateStatusEl = document.getElementById('today-live-senate-status');
    const senateLine1El = document.getElementById('today-live-senate-line1');
    const senateLine2El = document.getElementById('today-live-senate-line2');

    const committeeCountEl = document.getElementById('today-live-committee-count');
    const committeesEl = document.getElementById('today-live-committees');

    const weekOfEl = document.getElementById('today-live-weekof');
    const weekSectionsEl = document.getElementById('today-live-week-sections');

    const sourcesEl = document.getElementById('today-live-sources');

    if (
      !(dateEl instanceof HTMLElement) ||
      !(loadingEl instanceof HTMLElement) ||
      !(errorEl instanceof HTMLElement) ||
      !(contentEl instanceof HTMLElement) ||
      !(headlineEl instanceof HTMLElement) ||
      !(deckEl instanceof HTMLElement) ||
      !(bulletsEl instanceof HTMLElement) ||
      !(houseStatusEl instanceof HTMLElement) ||
      !(houseLine1El instanceof HTMLElement) ||
      !(houseLine2El instanceof HTMLElement) ||
      !(senateStatusEl instanceof HTMLElement) ||
      !(senateLine1El instanceof HTMLElement) ||
      !(senateLine2El instanceof HTMLElement) ||
      !(committeeCountEl instanceof HTMLElement) ||
      !(committeesEl instanceof HTMLUListElement) ||
      !(weekOfEl instanceof HTMLElement) ||
      !(weekSectionsEl instanceof HTMLElement) ||
      !(sourcesEl instanceof HTMLUListElement)
    ) {
      // Markup changed or script is running in a non-DOM context.
      // Fail closed: keep the page static and avoid noisy errors.
      return;
    }

    const safeDateEl: HTMLElement = dateEl;
    const safeLoadingEl: HTMLElement = loadingEl;
    const safeErrorEl: HTMLElement = errorEl;
    const safeContentEl: HTMLElement = contentEl;
    const safeHeadlineEl: HTMLElement = headlineEl;
    const safeDeckEl: HTMLElement = deckEl;
    const safeBulletsEl: HTMLElement = bulletsEl;
    const safeHouseStatusEl: HTMLElement = houseStatusEl;
    const safeHouseLine1El: HTMLElement = houseLine1El;
    const safeHouseLine2El: HTMLElement = houseLine2El;
    const safeSenateStatusEl: HTMLElement = senateStatusEl;
    const safeSenateLine1El: HTMLElement = senateLine1El;
    const safeSenateLine2El: HTMLElement = senateLine2El;
    const safeCommitteeCountEl: HTMLElement = committeeCountEl;
    const safeCommitteesEl: HTMLUListElement = committeesEl;
    const safeWeekOfEl: HTMLElement = weekOfEl;
    const safeWeekSectionsEl: HTMLElement = weekSectionsEl;
    const safeSourcesEl: HTMLUListElement = sourcesEl;

    function truncate(text: string, max = 220): string {
      if (!text || text.length <= max) return text || '';
      return `${text.slice(0, max - 1).trim()}...`;
    }

    function statusClass(status: string): string {
      if (/adjourned/i.test(status || '')) return 'text-red-700';
      if (/session/i.test(status || '')) return 'text-green-700';
      return 'text-navy-900';
    }

    function listItems(target: HTMLUListElement, values: string[]) {
      target.replaceChildren();
      values.forEach((value) => {
        const li = document.createElement('li');
        li.textContent = value;
        target.appendChild(li);
      });
    }

    function renderBullets(values: string[]) {
      safeBulletsEl.replaceChildren();

      const categories: [RegExp, string][] = [
        [/^Power center/i, 'Activity'],
        [/^Top agenda/i, 'Agenda'],
        [/^Spotlight/i, 'Spotlight'],
        [/^Policy load/i, 'Policy Load'],
        [/^Transparency/i, 'Transparency'],
        [/^Paper trail/i, 'Records'],
      ];

      values.forEach((value) => {
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-gold-200 bg-cream-50 p-3';

        let label = 'Update';
        let body = value;

        for (const [pattern, catLabel] of categories) {
          if (pattern.test(value)) {
            label = catLabel;
            const colonIdx = value.indexOf(':');
            if (colonIdx > 0) body = value.slice(colonIdx + 1).trim();
            break;
          }
        }

        const labelEl = document.createElement('p');
        labelEl.className = 'font-mono text-[10px] uppercase tracking-[0.16em] text-gold-600';
        labelEl.textContent = label;

        const textEl = document.createElement('p');
        textEl.className = 'mt-1 font-sans text-sm leading-relaxed text-navy-700';
        textEl.textContent = body;

        card.appendChild(labelEl);
        card.appendChild(textEl);
        safeBulletsEl.appendChild(card);
      });
    }

    function renderMeetings(meetings: TodayMeeting[] | null | undefined, meetingNotes: Record<string, string> = {}) {
      safeCommitteesEl.replaceChildren();

      if (!Array.isArray(meetings) || meetings.length === 0) {
        const empty = document.createElement('li');
        empty.className =
          'col-span-full rounded-lg border border-gold-200 bg-cream-100 p-3 font-sans text-sm text-navy-700';
        empty.textContent = 'No House or Senate committee meetings are listed for today.';
        safeCommitteesEl.appendChild(empty);
        return;
      }

      meetings.slice(0, 12).forEach((meeting) => {
        const item = document.createElement('li');
        item.className = 'rounded-lg border border-gold-200 bg-cream-50 p-4';

        const topRow = document.createElement('div');
        topRow.className = 'flex flex-wrap items-center gap-2';

        const chamberBadge = document.createElement('span');
        const isHouse = (meeting.chamber || '').toLowerCase() === 'house';
        chamberBadge.className = isHouse
          ? 'rounded-full bg-navy-800 px-2 py-0.5 font-mono text-[10px] uppercase tracking-wider text-cream-100'
          : 'rounded-full bg-gold-700 px-2 py-0.5 font-mono text-[10px] uppercase tracking-wider text-cream-100';
        chamberBadge.textContent = meeting.chamber || 'Committee';
        topRow.appendChild(chamberBadge);

        if (meeting.time) {
          const timeEl = document.createElement('span');
          timeEl.className = 'font-mono text-xs text-navy-500';
          timeEl.textContent = meeting.time;
          topRow.appendChild(timeEl);
        }

        if (meeting.isClosed) {
          const closedBadge = document.createElement('span');
          closedBadge.className =
            'rounded bg-red-100 px-1.5 py-0.5 font-mono text-[10px] uppercase text-red-700';
          closedBadge.textContent = 'Closed';
          topRow.appendChild(closedBadge);
        }

        const committee = document.createElement('p');
        committee.className = 'mt-2 font-serif text-base font-bold text-navy-900';
        committee.textContent = meeting.committee || meeting.title || 'Committee meeting';

        const committeeKey = meeting.committee || '';
        const aiNote = meetingNotes[committeeKey];
        const focusText = aiNote || meeting.focus || meeting.type || '';
        item.appendChild(topRow);
        item.appendChild(committee);

        if (focusText) {
          const focusEl = document.createElement('p');
          focusEl.className = aiNote
            ? 'mt-1 font-sans text-sm italic text-navy-600'
            : 'mt-1 font-sans text-sm text-navy-600';
          focusEl.textContent = focusText;
          item.appendChild(focusEl);
        }

        const meta: string[] = [];
        const billCount =
          typeof meeting.relatedBillCount === 'number' ? meeting.relatedBillCount : 0;
        const nomCount =
          typeof meeting.relatedNominationCount === 'number'
            ? meeting.relatedNominationCount
            : 0;
        if (billCount > 0) meta.push(`${billCount} bill${billCount === 1 ? '' : 's'}`);
        if (nomCount > 0) meta.push(`${nomCount} nomination${nomCount === 1 ? '' : 's'}`);
        if (meeting.location) meta.push(meeting.location);

        if (meta.length > 0) {
          const metaEl = document.createElement('p');
          metaEl.className = 'mt-2 font-sans text-xs text-navy-400';
          metaEl.textContent = meta.join(' \u00b7 ');
          item.appendChild(metaEl);
        }

        safeCommitteesEl.appendChild(item);
      });
    }

    function renderWeekAgenda(agenda: WeekAgenda | null | undefined) {
      safeWeekSectionsEl.replaceChildren();

      if (!agenda || !Array.isArray(agenda.sections) || agenda.sections.length === 0) {
        safeWeekOfEl.textContent = 'No House floor agenda sections were parsed.';
        return;
      }

      safeWeekOfEl.textContent = agenda.weekOf
        ? `Week of ${agenda.weekOf}`
        : 'Current House floor agenda';

      agenda.sections.slice(0, 3).forEach((section) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'rounded-lg border border-gold-200 bg-cream-100 p-3';

        const title = document.createElement('h3');
        title.className = 'font-serif text-lg font-bold text-navy-900';
        title.textContent = section.section || 'Agenda section';

        const ul = document.createElement('ul');
        ul.className = 'mt-2 space-y-1 font-sans text-sm text-navy-700';

        (section.items || []).slice(0, 6).forEach((item) => {
          const li = document.createElement('li');
          const bill = item.bill ? `${item.bill}: ` : '';
          li.textContent = truncate(`${bill}${item.title || ''}`, 170);
          ul.appendChild(li);
        });

        wrapper.appendChild(title);
        wrapper.appendChild(ul);
        safeWeekSectionsEl.appendChild(wrapper);
      });
    }

    function renderSources(sources: TodaySource[] | null | undefined) {
      if (!Array.isArray(sources) || sources.length === 0) {
        listItems(safeSourcesEl, ['No source health metadata found.']);
        return;
      }

      function sourceLabel(key: string | undefined): string {
        switch (key) {
          case 'officialLiveFeeds':
          case 'congressApiKey':
            return 'Official live feeds';
          default:
            return key || 'Source';
        }
      }

      function sourceStatus(source: TodaySource): string {
        const status = String(source?.status || '').toLowerCase();
        const rawError = String(source?.error || '');
        const safeError = /missing key/i.test(rawError)
          ? 'Not configured in this deployment.'
          : rawError || 'Unknown issue.';

        if (status === 'ok') return 'operational';
        if (status === 'unavailable') return `unavailable (${safeError})`;
        return `degraded (${safeError})`;
      }

      listItems(
        safeSourcesEl,
        sources.map((source) => {
          return `${sourceLabel(source?.key)}: ${sourceStatus(source)}`;
        }),
      );
    }

    async function requestTodayData(): Promise<any> {
      const endpoints = ['/api/today.json', '/api/today-fallback.json'];
      let lastError: unknown;

      for (const endpoint of endpoints) {
        try {
          const response = await fetch(endpoint, {
            headers: { Accept: 'application/json' },
          });
          if (!response.ok) {
            lastError = new Error(`${endpoint} returned HTTP ${response.status}`);
            continue;
          }
          const data = await response.json();
          return data;
        } catch (error: unknown) {
          lastError = error;
        }
      }

      throw lastError instanceof Error
        ? lastError
        : new Error('Unable to load today data from available endpoints.');
    }

    async function loadTodayLive() {
      try {
        const data = await requestTodayData();
        const summary = data?.summary || {};
        const isAi = summary.satireSource === 'ai';

        safeDateEl.textContent = data?.today?.label || 'Today';
        safeHeadlineEl.textContent = summary.headline || '';
        safeDeckEl.textContent =
          summary.deck ||
          'Satire desk is waiting for proceedings to escalate beyond procedural verbs.';
        renderBullets(
          Array.isArray(summary.bullets) ? summary.bullets.map(String) : [],
        );

        const house = data?.chambers?.house || {};
        safeHouseStatusEl.textContent = house.status || 'No update';
        safeHouseStatusEl.className = `mt-1 font-serif text-2xl font-bold ${statusClass(house.status)}`;
        safeHouseLine1El.textContent = isAi && summary.houseLine
          ? summary.houseLine
          : house.latestAction?.text
            ? `${house.latestAction.time ? `${house.latestAction.time}: ` : ''}${truncate(house.latestAction.text, 190)}`
            : 'No House floor action posted yet.';
        safeHouseLine2El.textContent = house.nextConvene
          ? `Next House meeting: ${house.nextConvene}`
          : 'Next meeting not posted.';

        const senate = data?.chambers?.senate || {};
        safeSenateStatusEl.textContent = senate.status || 'No update';
        safeSenateStatusEl.className = `mt-1 font-serif text-2xl font-bold ${statusClass(senate.status)}`;
        safeSenateLine1El.textContent = isAi && summary.senateLine
          ? summary.senateLine
          : senate.previousSummary
            ? truncate(senate.previousSummary, 210)
            : 'No Senate floor summary posted yet.';
        safeSenateLine2El.textContent = senate.nextConvene
          ? `Next Senate meeting: ${senate.nextConvene}`
          : 'Next meeting not posted.';

        const committeeTotal = data?.committees?.totalToday;
        safeCommitteeCountEl.textContent = Number.isFinite(committeeTotal)
          ? `${committeeTotal} House and Senate meetings listed today.`
          : 'Committee counts are unavailable.';

        const meetingNotes: Record<string, string> = isAi && summary.meetingNotes ? summary.meetingNotes : {};
        renderMeetings(data?.committees?.meetings, meetingNotes);

        renderWeekAgenda(data?.houseWeekAgenda);
        renderSources(data?.sources);

        safeLoadingEl.classList.add('hidden');
        safeErrorEl.classList.add('hidden');
        safeContentEl.classList.remove('hidden');
      } catch (_error) {
        safeLoadingEl.classList.add('hidden');
        safeContentEl.classList.add('hidden');
        safeErrorEl.classList.remove('hidden');
      }
    }

    loadTodayLive();
  });
</script>
