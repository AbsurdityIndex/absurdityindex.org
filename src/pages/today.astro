---
import BaseLayout from '../layouts/BaseLayout.astro';
import Divider from '../components/ui/Divider.astro';
import BillCard from '../components/bills/BillCard.astro';
import { getCollection } from 'astro:content';

// Get all bills
const allBills = await getCollection('bills');

// Get today's date info
const today = new Date();
const dateOptions: Intl.DateTimeFormatOptions = {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
};
const formattedDate = today.toLocaleDateString('en-US', dateOptions);

// Session status logic (simplified from SessionCalendar)
const sessionPeriods2025: [string, string][] = [
  ['2025-01-03', '2025-01-19'],
  ['2025-02-03', '2025-02-16'],
  ['2025-02-24', '2025-03-23'],
  ['2025-04-07', '2025-05-25'],
  ['2025-06-02', '2025-07-03'],
  ['2025-09-08', '2025-10-12'],
  ['2025-11-10', '2025-11-23'],
  ['2025-12-01', '2025-12-18'],
];

const recessPeriods2025 = [
  { start: '2025-01-20', end: '2025-02-02', name: 'Inauguration Recess' },
  { start: '2025-02-17', end: '2025-02-23', name: "Presidents' Day Recess" },
  { start: '2025-03-24', end: '2025-04-06', name: 'Easter Recess' },
  { start: '2025-05-26', end: '2025-06-01', name: 'Memorial Day Recess' },
  { start: '2025-07-04', end: '2025-09-07', name: 'Summer Recess' },
  { start: '2025-10-13', end: '2025-11-09', name: 'Columbus Day & Election Recess' },
  { start: '2025-11-24', end: '2025-11-30', name: 'Thanksgiving Recess' },
  { start: '2025-12-19', end: '2025-12-31', name: 'Holiday Recess' },
];

function formatDateStr(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function isInSession(date: Date): boolean {
  const dateStr = formatDateStr(date);
  return sessionPeriods2025.some(([start, end]) => dateStr >= start && dateStr <= end);
}

function getCurrentRecessName(date: Date): string | null {
  const dateStr = formatDateStr(date);
  const recess = recessPeriods2025.find(r => dateStr >= r.start && dateStr <= r.end);
  return recess?.name ?? null;
}

const inSession = isInSession(today);
const currentRecessName = !inSession ? getCurrentRecessName(today) : null;

// Get recent bills (most recent 3)
const recentBills = allBills
  .sort((a, b) => b.data.dateIntroduced.getTime() - a.data.dateIntroduced.getTime())
  .slice(0, 3);

// Mock committee hearings
const mockHearings = [
  {
    committee: 'Committee on Technology (avg. member age: 78)',
    title: 'Understanding the "WiFi": Is It a Series of Tubes?',
    time: '10:00 AM',
    room: 'Rayburn 2154',
  },
  {
    committee: 'Subcommittee on Obvious Ideas',
    title: 'Examining Whether Water is Wet: A Bipartisan Inquiry',
    time: '2:00 PM',
    room: 'Longworth 1100',
  },
  {
    committee: 'Joint Committee on Pretending to Work',
    title: 'Reconvening to Discuss Reconvening',
    time: '10:00 AM - 10:07 AM',
    room: 'Hart 216',
  },
];

// Mock votes
const mockVotes = [
  {
    bill: 'H.R. 8675309',
    title: 'Naming the Post Office on 5th Street',
    result: 'Passed',
    yeas: 412,
    nays: 3,
    comment: 'Finally, bipartisan unity on what truly matters.',
  },
  {
    bill: 'S. Res. 42',
    title: 'Recognizing National Obscure Awareness Month',
    result: 'Passed',
    yeas: 89,
    nays: 0,
    comment: 'Nobody knew what it was, but everyone voted yes.',
  },
];

// Calculate productivity score based on session status and day of week
const dayOfWeek = today.getDay();
const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
let productivityScore = inSession ? (isWeekend ? 1 : Math.floor(Math.random() * 3) + 2) : 0;
const productivityComments: Record<number, string> = {
  0: "Congress is on recess. Your tax dollars are napping.",
  1: "Technically present, spiritually absent.",
  2: "A valiant effort was made. By someone. Somewhere.",
  3: "Nearly functional. Don't get used to it.",
  4: "Suspicious levels of productivity detected.",
  5: "Check for errors. This can't be right.",
};

// Snarky time of day greeting
const hour = today.getHours();
let timeGreeting = '';
if (hour < 10) {
  timeGreeting = "Before Congress's traditional 10 AM arrival time";
} else if (hour < 12) {
  timeGreeting = "Morning session (coffee consumption phase)";
} else if (hour < 14) {
  timeGreeting = "Lunch recess (the most productive recess)";
} else if (hour < 17) {
  timeGreeting = "Afternoon session (power nap phase)";
} else {
  timeGreeting = "After hours (lobbyist happy hour)";
}
---

<BaseLayout
  title="What Did Congress Do Today?"
  description="Real-time updates on congressional activity, or lack thereof. See what your representatives accomplished today."
>
  <div class="max-w-5xl mx-auto px-4 py-12">
    <!-- Header -->
    <header class="text-center mb-10">
      <p class="font-mono text-xs uppercase tracking-[0.2em] text-gold-600 mb-2">
        Daily Congressional Dispatch
      </p>
      <h1 class="font-serif text-3xl md:text-4xl font-bold text-navy-900 mb-4">
        What Did Congress Do Today?
      </h1>
      <p class="font-serif text-2xl text-navy-700 mb-2">{formattedDate}</p>
      <p class="font-sans text-sm text-navy-500 italic">{timeGreeting}</p>
      <div class="gold-rule max-w-xs mx-auto mt-6"></div>
    </header>

    <!-- Session Status Banner -->
    <div class={`rounded-lg p-6 mb-10 ${inSession ? 'bg-green-700/10 border-2 border-green-700/30' : 'bg-red-600/10 border-2 border-red-600/30'}`}>
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <span class={`w-4 h-4 rounded-full pulse-subtle ${inSession ? 'bg-green-600' : 'bg-red-600'}`}></span>
          <div>
            <p class={`font-serif font-bold text-xl ${inSession ? 'text-green-700' : 'text-red-700'}`}>
              Congress is currently {inSession ? 'IN SESSION' : 'ON RECESS'}
            </p>
            {currentRecessName && (
              <p class="text-navy-600 font-sans text-sm">{currentRecessName}</p>
            )}
          </div>
        </div>
        <a
          href="/calendar"
          class="font-sans text-sm text-navy-600 hover:text-gold-600 transition-colors underline"
        >
          View Full Calendar &rarr;
        </a>
      </div>
    </div>

    <!-- Daily Productivity Score -->
    <div class="bg-parchment rounded-lg shadow-lg p-6 mb-10 text-center">
      <p class="font-mono text-xs uppercase tracking-widest text-navy-500 mb-2">Today's Productivity Score</p>
      <div class="flex items-center justify-center gap-1 mb-3">
        {Array.from({ length: 5 }).map((_, i) => (
          <div class={`w-8 h-8 rounded ${i < productivityScore ? 'bg-gold-500' : 'bg-navy-200'}`}></div>
        ))}
      </div>
      <p class="font-mono text-2xl font-bold text-navy-900 mb-2">{productivityScore}/5</p>
      <p class="font-serif text-navy-600 italic">{productivityComments[productivityScore]}</p>
    </div>

    <Divider />

    <!-- Bills Introduced Section -->
    <section class="mt-10">
      <h2 class="font-serif text-2xl font-bold text-navy-900 mb-2">
        Recent Bills
      </h2>
      <p class="font-sans text-sm text-navy-600 mb-6">
        The latest legislation to grace (or disgrace) the congressional record
      </p>

      {recentBills.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {recentBills.map((bill) => (
            <BillCard bill={bill} />
          ))}
        </div>
      ) : (
        <div class="bg-parchment rounded-lg p-8 text-center">
          <p class="font-serif text-navy-600 italic">
            No bills today. Congress is either on recess or experiencing a rare moment of legislative restraint.
          </p>
        </div>
      )}

      <div class="text-center mt-6">
        <a href="/bills" class="font-sans text-sm text-navy-600 hover:text-gold-600 transition-colors underline">
          View All Bills &rarr;
        </a>
      </div>
    </section>

    <Divider withSeal={true} />

    <!-- Votes Held Section -->
    <section class="mt-10">
      <h2 class="font-serif text-2xl font-bold text-navy-900 mb-2">
        Votes Held
      </h2>
      <p class="font-sans text-sm text-navy-600 mb-6">
        Democracy in action (results may vary)
      </p>

      <div class="space-y-4">
        {mockVotes.map((vote) => (
          <div class="bg-parchment rounded-lg p-6 border border-gold-200">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div>
                <p class="font-mono text-sm text-gold-600">{vote.bill}</p>
                <p class="font-serif font-semibold text-navy-900">{vote.title}</p>
              </div>
              <div class="text-right">
                <span class={`inline-block px-3 py-1 rounded font-sans text-sm font-semibold ${
                  vote.result === 'Passed' ? 'bg-green-700/20 text-green-700' : 'bg-red-600/20 text-red-700'
                }`}>
                  {vote.result}
                </span>
                <p class="font-mono text-sm text-navy-600 mt-1">
                  Yeas: {vote.yeas} | Nays: {vote.nays}
                </p>
              </div>
            </div>
            <p class="font-serif text-sm text-navy-500 italic mt-3 border-t border-gold-200 pt-3">
              "{vote.comment}"
            </p>
          </div>
        ))}
      </div>

      {!inSession && (
        <div class="bg-navy-800 rounded-lg p-6 mt-6 text-center">
          <p class="font-serif text-gold-300 italic">
            No votes scheduled during recess. Democracy will resume at a later date.
          </p>
        </div>
      )}
    </section>

    <Divider />

    <!-- Committee Hearings Section -->
    <section class="mt-10">
      <h2 class="font-serif text-2xl font-bold text-navy-900 mb-2">
        Committee Hearings
      </h2>
      <p class="font-sans text-sm text-navy-600 mb-6">
        Where legislation goes to be thoroughly ignored
      </p>

      <div class="space-y-4">
        {mockHearings.map((hearing) => (
          <div class="bg-white rounded-lg border border-navy-200 p-5 shadow-sm">
            <div class="flex flex-col md:flex-row md:items-start justify-between gap-3">
              <div>
                <p class="font-sans text-xs uppercase tracking-widest text-gold-600 mb-1">
                  {hearing.committee}
                </p>
                <p class="font-serif font-semibold text-navy-900 text-lg">
                  "{hearing.title}"
                </p>
              </div>
              <div class="text-left md:text-right shrink-0">
                <p class="font-mono text-sm text-navy-800">{hearing.time}</p>
                <p class="font-sans text-xs text-navy-500">{hearing.room}</p>
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>

    <Divider withSeal={true} />

    <!-- Daily Summary -->
    <section class="mt-10 bg-navy-900 rounded-lg p-8 text-center">
      <p class="font-mono text-xs uppercase tracking-widest text-gold-500 mb-3">
        Daily Summary
      </p>
      <p class="font-serif text-xl text-gold-300 leading-relaxed max-w-2xl mx-auto">
        {inSession ? (
          "Congress convened, debated, and accomplished approximately what you'd expect. Another day, another dollar (of your taxes)."
        ) : (
          "Congress remains on recess. Your representatives are hard at work in their districts, attending fundraisers and avoiding town halls."
        )}
      </p>
      <p class="font-mono text-sm text-navy-400 mt-6">
        Productivity Score: {productivityScore}/5 | Session Status: {inSession ? 'Active' : 'Recess'}
      </p>
    </section>

    <!-- Back link -->
    <div class="text-center mt-10">
      <a href="/" class="text-navy-600 hover:text-gold-600 font-serif transition-colors">
        &larr; Back to Home
      </a>
    </div>
  </div>
</BaseLayout>
