---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AbsurdityMeter from '../../components/bills/AbsurdityMeter.astro';
import { billsUnderConsideration, categories } from '../../data/under-consideration';

// Sort by absurdity index descending by default
const bills = [...billsUnderConsideration].sort((a, b) => b.absurdityIndex - a.absurdityIndex);
---

<BaseLayout
  title="Under Consideration"
  description="Real bills currently under consideration in the 119th Congress, ranked by absurdity. Each links to its official Congress.gov page."
>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <div class="text-center mb-8">
      <p class="text-sm text-red-600 font-mono uppercase tracking-widest mb-2">
        119th Congress &mdash; Currently Active
      </p>
      <h1 class="font-serif text-3xl md:text-4xl text-navy-900 font-bold">
        Bills Under Consideration
      </h1>
      <p class="text-navy-600 font-serif italic mt-2">
        Real bills sitting in committee right now, ranked by how absurd they are
      </p>
      <p class="text-navy-500 text-sm font-sans mt-3">
        {bills.length} bills &middot; All links go to official Congress.gov pages
      </p>
      <div
        class="max-w-2xl mx-auto mt-4 bg-cream-200 border border-gold-300 rounded p-3 text-xs text-navy-600 leading-relaxed"
      >
        <strong>Work in progress:</strong> Bill data is scraped from public records and may not reflect
        the latest status or amendments. Absurdity scores are subjective editorial ratings, not objective
        measures. Descriptions represent editorial commentary, not statements about any legislator's intent.
        Always verify at <a
          href="https://www.congress.gov"
          target="_blank"
          rel="noopener noreferrer"
          class="underline hover:text-navy-800">Congress.gov</a
        >.
      </div>
    </div>
    <div class="gold-rule"></div>

    <!-- Category filter chips -->
    <nav class="flex flex-wrap items-center gap-2 mt-8 mb-2" aria-label="Filter by category">
      <button
        class="filter-chip active inline-block text-xs font-sans font-semibold px-3 py-1.5 rounded-full border bg-navy-800 text-white border-navy-800 transition-colors"
        data-category="all"
      >
        All ({bills.length})
      </button>
      {
        categories.map((cat) => {
          const count = bills.filter((b) => b.category === cat).length;
          return (
            <button
              class="filter-chip inline-block text-xs font-sans font-semibold px-3 py-1.5 rounded-full border border-navy-700 text-navy-700 hover:bg-navy-800 hover:text-white hover:border-navy-800 transition-colors"
              data-category={cat}
            >
              {cat} ({count})
            </button>
          );
        })
      }
    </nav>

    <!-- Sort control -->
    <div class="flex items-center justify-between mt-4 mb-6">
      <div class="flex items-center gap-2">
        <label
          for="sort-select"
          class="text-xs font-sans font-semibold text-navy-600 uppercase tracking-wide"
          >Sort by</label
        >
        <select
          id="sort-select"
          class="text-sm font-sans border border-cream-300 rounded px-2 py-1 bg-white text-navy-800"
        >
          <option value="absurdity-desc">Most Absurd First</option>
          <option value="absurdity-asc">Least Absurd First</option>
          <option value="bill-number">Bill Number</option>
        </select>
      </div>
      <p id="visible-count" class="text-xs text-navy-500 font-sans">
        Showing {bills.length} bills
      </p>
    </div>

    <!-- Bills list -->
    <div id="bills-list" class="space-y-4">
      {
        bills.map((bill) => (
          <article
            class="bill-row group bg-white border-l-4 border-l-navy-500 rounded-sm shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 p-5"
            data-category={bill.category}
            data-absurdity={bill.absurdityIndex}
            data-bill-number={bill.billNumber}
            data-title={bill.title.toLowerCase()}
            data-sponsor={bill.sponsor.toLowerCase()}
          >
            <div class="flex flex-col md:flex-row md:items-start gap-4">
              {/* Bill info */}
              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2 mb-2">
                  <span class="font-mono text-sm font-bold text-navy-800 bg-navy-900/5 px-2 py-0.5 rounded">
                    {bill.billNumber}
                  </span>
                  <span class="inline-block text-xs font-sans font-semibold px-2.5 py-0.5 rounded-full bg-navy-600 text-white">
                    {bill.category}
                  </span>
                  <span class="text-xs text-navy-500 font-sans">{bill.congress}th Congress</span>
                </div>

                <h3 class="font-serif text-lg font-bold text-navy-900 leading-snug mb-1">
                  <a
                    href={bill.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="hover:text-navy-600 transition-colors"
                  >
                    {bill.title}
                    <svg
                      class="inline-block w-3.5 h-3.5 ml-1 opacity-40 group-hover:opacity-100 transition-opacity"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                      />
                    </svg>
                  </a>
                </h3>

                <p class="text-sm text-navy-700 leading-relaxed mb-2">{bill.description}</p>

                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-navy-600">
                  <span class="font-sans font-medium">{bill.sponsor}</span>
                  <span
                    class:list={[
                      'font-sans font-semibold px-2 py-0.5 rounded-full',
                      bill.status.includes('Passed')
                        ? 'bg-gold-200 text-navy-800'
                        : 'bg-cream-200 text-navy-700',
                    ]}
                  >
                    {bill.status}
                  </span>
                </div>
              </div>

              {/* Absurdity meter (compact) */}
              <div class="w-32 shrink-0 self-center">
                <AbsurdityMeter score={bill.absurdityIndex} />
              </div>
            </div>
          </article>
        ))
      }
    </div>

    <div id="no-results" class="hidden text-center py-16">
      <p class="font-serif text-2xl text-navy-600 mb-2">No bills in this category.</p>
      <p class="text-navy-400 italic">
        Even Congress can't be absurd in every direction at once. Almost, though.
      </p>
    </div>
  </div>

  <script>
    const billRows = document.querySelectorAll('.bill-row');
    const filterChips = document.querySelectorAll('.filter-chip');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const billsList = document.getElementById('bills-list');
    const noResults = document.getElementById('no-results');
    const visibleCount = document.getElementById('visible-count');
    let activeCategory = 'all';

    function updateVisibility() {
      let count = 0;
      billRows.forEach((row) => {
        const el = row as HTMLElement;
        const cat = el.dataset.category || '';
        const visible = activeCategory === 'all' || cat === activeCategory;
        el.style.display = visible ? '' : 'none';
        if (visible) count++;
      });

      if (noResults && billsList) {
        noResults.classList.toggle('hidden', count > 0);
        billsList.classList.toggle('hidden', count === 0);
      }
      if (visibleCount) {
        visibleCount.textContent = `Showing ${count} bill${count !== 1 ? 's' : ''}`;
      }
    }

    function sortBills() {
      if (!billsList) return;
      const rows = Array.from(billRows) as HTMLElement[];
      const sortBy = sortSelect?.value || 'absurdity-desc';

      rows.sort((a, b) => {
        if (sortBy === 'absurdity-desc') {
          return (Number(b.dataset.absurdity) || 0) - (Number(a.dataset.absurdity) || 0);
        } else if (sortBy === 'absurdity-asc') {
          return (Number(a.dataset.absurdity) || 0) - (Number(b.dataset.absurdity) || 0);
        } else {
          return (a.dataset.billNumber || '').localeCompare(b.dataset.billNumber || '');
        }
      });

      rows.forEach((row) => billsList.appendChild(row));
    }

    filterChips.forEach((chip) => {
      chip.addEventListener('click', () => {
        filterChips.forEach((c) => {
          c.classList.remove('active', 'bg-navy-800', 'text-white', 'border-navy-800');
          c.classList.add('border-navy-700', 'text-navy-700');
        });
        chip.classList.add('active', 'bg-navy-800', 'text-white', 'border-navy-800');
        chip.classList.remove('border-navy-700', 'text-navy-700');
        activeCategory = (chip as HTMLElement).dataset.category || 'all';
        updateVisibility();
      });
    });

    sortSelect?.addEventListener('change', sortBills);
  </script>
</BaseLayout>
