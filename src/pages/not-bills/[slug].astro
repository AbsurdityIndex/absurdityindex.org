---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BillHeader from '../../components/bills/BillHeader.astro';
import BillMeta from '../../components/bills/BillMeta.astro';
import PairedBillCallout from '../../components/bills/PairedBillCallout.astro';
import CommitteeStamp from '../../components/satirical/CommitteeStamp.astro';
import ShareButtons from '../../components/ui/ShareButtons.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const bills = await getCollection('bills');
  return bills
    .filter((bill) => bill.data.billType === 'sensible' || bill.data.billType === 'absurd')
    .map((bill) => ({
      params: { slug: bill.id },
      props: { bill },
    }));
}

const { bill } = Astro.props;
const { Content } = await render(bill);
const d = bill.data;

// Estimate reading time content from summary + base estimate for satirical bill content
const readingTimeContent = [
  d.summary || '',
  ' '.repeat(300), // Base padding for typical satirical bill content
].join(' ');

const billSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": d.title,
  "description": d.summary,
  "datePublished": d.dateIntroduced instanceof Date ? d.dateIntroduced.toISOString() : d.dateIntroduced,
  "author": {
    "@type": "Organization",
    "name": "Absurdity Index",
  },
  "publisher": {
    "@type": "Organization",
    "name": "Absurdity Index",
    "url": "https://absurdityindex.org",
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://absurdityindex.org/not-bills/${bill.id}`,
  },
};
---

<BaseLayout title={`${d.billNumber} — ${d.title}`} description={d.summary} ogType="article" article={{ publishedTime: d.dateIntroduced instanceof Date ? d.dateIntroduced.toISOString() : String(d.dateIntroduced), section: d.category, tags: d.tags }}>
  <script type="application/ld+json" set:html={JSON.stringify(billSchema)} />
  <div class="max-w-4xl mx-auto px-4 py-12">
    <div class="bg-parchment rounded-lg shadow-lg p-8 md:p-12 relative overflow-hidden">
      <CommitteeStamp text={d.status} />

      <BillHeader
        title={d.title}
        billNumber={d.billNumber}
        billType={d.billType}
        status={d.status}
        readingTimeContent={readingTimeContent}
      />

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8">
        <div class="md:col-span-2">
          <div class="bill-content">
            <Content />
          </div>

          <!-- Vote tally decoration -->
          <div class="mt-10 p-6 bg-cream-100 border border-gold-300 rounded">
            <h3 class="font-serif font-bold text-navy-900 text-lg mb-3">Recorded Vote</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <div class="text-2xl font-mono font-bold text-green-700">2</div>
                <div class="text-sm text-navy-600">Ayes</div>
              </div>
              <div>
                <div class="text-2xl font-mono font-bold text-red-700">433</div>
                <div class="text-sm text-navy-600">Nays</div>
              </div>
              <div>
                <div class="text-2xl font-mono font-bold text-navy-400">100</div>
                <div class="text-sm text-navy-600">Playing Candy Crush</div>
              </div>
            </div>
          </div>

          <ShareButtons
            title={`${d.billNumber} — ${d.title}`}
            summary={d.summary}
            url={`https://absurdityindex.org/not-bills/${bill.id}/`}
          />

          {d.pairedBillId && (
            <PairedBillCallout pairedBillId={d.pairedBillId} currentBillType={d.billType} />
          )}
        </div>

        <aside>
          <BillMeta
            sponsor={d.sponsor}
            cosponsors={d.cosponsors}
            committee={d.committee}
            status={d.status}
            dateIntroduced={d.dateIntroduced}
            dateUpdated={d.dateUpdated}
            realSource={d.realSource}
            realJurisdiction={d.realJurisdiction}
          />
        </aside>
      </div>
    </div>

    <div class="text-center mt-8">
      <a href="/not-bills" class="text-navy-600 hover:text-gold-600 font-serif transition-colors">
        &larr; Back to Not Bills
      </a>
    </div>
  </div>
</BaseLayout>
