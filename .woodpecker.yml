# ---------------------------------------------------------------------------
# Woodpecker CI â€” Build & Deploy to Cloudflare Pages
# ---------------------------------------------------------------------------
# Runs validation/build/test on push, pull request, and manual runs.
# Deploys to Cloudflare Pages only for push/manual on main.
#
# VoteChain is a separate repo whose pages are merged into the main site's
# dist/ at build time. Both repos build their own Astro output and the
# merge script copies VoteChain's /votechain/ pages + _astro/ assets in.
# ---------------------------------------------------------------------------

when:
  - event: [push, pull_request, manual]

steps:
  - name: install-site
    image: node:22-alpine
    commands:
      - npm ci

  - name: security-audit
    image: node:22-alpine
    commands:
      - npm run security:audit

  - name: secret-scan
    image: node:22-alpine
    commands:
      - npm run security:scan-secrets

  - name: validate-content
    image: node:22-alpine
    commands:
      - npm run validate:ci

  - name: build-site
    image: node:22-alpine
    commands:
      - npm run build

  - name: build-votechain
    image: node:22-alpine
    commands:
      - git clone --depth 1 https://github.com/AbsurdityIndex/votechain.git /tmp/votechain
      - cd /tmp/votechain && npm ci && npm run build
      - cp -R /tmp/votechain/dist/votechain/ dist/votechain/
      - cp -R /tmp/votechain/dist/_astro/* dist/_astro/

  - name: deploy
    image: node:22-alpine
    commands:
      - npx wrangler pages deploy dist/ --project-name absurdity-index --branch main --commit-hash ${CI_COMMIT_SHA}
    when:
      - event: [push, manual]
        branch: main
    environment:
      CLOUDFLARE_API_TOKEN:
        from_secret: cloudflare_api_token
      CLOUDFLARE_ACCOUNT_ID:
        from_secret: cloudflare_account_id
